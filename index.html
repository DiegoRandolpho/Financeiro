<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanças Família</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body id="app">

    <div v-if="!session" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Login Família</h1>
            <input v-model="email" type="email" placeholder="Seu e-mail" class="w-full p-3 border rounded mb-4">
            <input v-model="password" type="password" placeholder="Sua senha" class="w-full p-3 border rounded mb-4">
            <button @click="handleLogin" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold">
                Entrar
            </button>
            <p v-if="authError" class="text-red-500 mt-4 text-sm text-center">{{ authError }}</p>
        </div>
    </div>

    <div v-else class="pb-20">
        
        <header class="bg-white shadow p-4 sticky top-0 z-10 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-gray-800">Orçamento Mensal</h1>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <button @click="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <span class="font-mono">{{ currentMonthName }}</span>
                    <button @click="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <button @click="logout" class="text-red-500 text-sm"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <main class="p-4 space-y-4">
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                    <p class="text-xs text-gray-500">Total Orçado</p>
                    <p class="text-xl font-bold text-gray-800">R$ {{ formatMoney(totalBudget) }}</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
                    <p class="text-xs text-gray-500">Total Gasto</p>
                    <p class="text-xl font-bold text-gray-800">R$ {{ formatMoney(totalSpent) }}</p>
                </div>
            </div>

            <h2 class="font-bold text-gray-700 mb-2">Por Centro de Custo</h2>
            <div v-for="cat in categories" :key="cat.id" class="bg-white p-4 rounded-lg shadow mb-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <div :style="{ backgroundColor: cat.color }" class="w-3 h-3 rounded-full"></div>
                        <span class="font-semibold text-gray-700">{{ cat.name }}</span>
                    </div>
                    <span class="text-sm font-bold" :class="getBudgetColor(cat.spent, cat.budget_limit)">
                        R$ {{ formatMoney(cat.spent) }} / {{ formatMoney(cat.budget_limit) }}
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="progress-bar h-2.5 rounded-full" 
                         :style="{ width: getPercentage(cat.spent, cat.budget_limit) + '%', backgroundColor: cat.color }">
                    </div>
                </div>
            </div>

            <div v-if="categories.length === 0" class="text-center text-gray-500 mt-10">
                Nenhuma categoria ativa para este período.
            </div>

        </main>

        <div class="fixed bottom-6 right-6 flex flex-col gap-3">
            <button @click="showCategoryModal = true" class="bg-gray-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center">
                <i class="fas fa-tags"></i>
            </button>
            <button @click="showTransactionModal = true" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div v-if="showTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
            <div class="bg-white w-full sm:max-w-md p-6 rounded-t-xl sm:rounded-xl shadow-2xl h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">Novo Gasto</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600">Descrição</label>
                        <input v-model="newTransaction.description" type="text" class="w-full p-2 border rounded">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600">Valor (R$)</label>
                            <input v-model="newTransaction.amount" type="number" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Data Compra</label>
                            <input v-model="newTransaction.date" type="date" class="w-full p-2 border rounded">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600">Categoria</label>
                        <select v-model="newTransaction.category_id" class="w-full p-2 border rounded bg-white">
                            <option v-for="c in allCategories" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600">Responsável</label>
                        <div class="flex gap-2 mt-1">
                            <button @click="newTransaction.owner_type = 'me'" :class="newTransaction.owner_type === 'me' ? 'bg-blue-600 text-white' : 'bg-gray-200'" class="flex-1 p-2 rounded text-sm">Eu</button>
                            <button @click="newTransaction.owner_type = 'her'" :class="newTransaction.owner_type === 'her' ? 'bg-pink-600 text-white' : 'bg-gray-200'" class="flex-1 p-2 rounded text-sm">Ela</button>
                            <button @click="newTransaction.owner_type = 'both'" :class="newTransaction.owner_type === 'both' ? 'bg-purple-600 text-white' : 'bg-gray-200'" class="flex-1 p-2 rounded text-sm">Ambos</button>
                        </div>
                    </div>

                    <div class="border-t pt-4 mt-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" v-model="newTransaction.is_installment">
                            <span class="text-sm font-bold text-gray-700">É parcelado?</span>
                        </label>
                        
                        <div v-if="newTransaction.is_installment" class="mt-2">
                            <label class="block text-sm text-gray-600">Número de Parcelas</label>
                            <input v-model="newTransaction.installments_total" type="number" min="2" max="24" class="w-full p-2 border rounded">
                            <p class="text-xs text-orange-600 mt-1">O sistema lançará automaticamente nos meses futuros.</p>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="showTransactionModal = false" class="flex-1 p-3 text-gray-600 border rounded">Cancelar</button>
                        <button @click="saveTransaction" class="flex-1 p-3 bg-blue-600 text-white rounded font-bold" :disabled="loading">
                            {{ loading ? 'Salvando...' : 'Salvar' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
            <div class="bg-white w-full sm:max-w-md p-6 rounded-t-xl sm:rounded-xl shadow-2xl">
                <h3 class="text-xl font-bold mb-4">Configurar Orçamento</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600">Nome (Ex: Mercado)</label>
                        <input v-model="newCategory.name" type="text" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Orçamento Mensal (R$)</label>
                        <input v-model="newCategory.budget_limit" type="number" step="0.01" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Cor</label>
                        <input v-model="newCategory.color" type="color" class="w-full h-10 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Data Início Vigência</label>
                        <input v-model="newCategory.valid_from" type="date" class="w-full p-2 border rounded">
                    </div>
                     <div>
                        <label class="block text-sm text-gray-600">Data Fim (Opcional)</label>
                        <input v-model="newCategory.valid_until" type="date" class="w-full p-2 border rounded">
                        <p class="text-xs text-gray-500">Deixe em branco para "Ativo/Indefinido"</p>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="showCategoryModal = false" class="flex-1 p-3 text-gray-600 border rounded">Cancelar</button>
                        <button @click="saveCategory" class="flex-1 p-3 bg-green-600 text-white rounded font-bold" :disabled="loading">
                            {{ loading ? 'Salvando...' : 'Criar' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
    const { createClient } = supabase;

    // --- CONFIGURAÇÃO ---
    // Substitua pelas suas chaves do Supabase
    const SUPABASE_URL = 'https://ccktnhugjrgeafmialib.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg';
    
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // Estados Reativos
            const session = ref(null);
            const email = ref('');
            const password = ref('');
            const authError = ref('');
            const loading = ref(false);
            
            const currentDate = ref(new Date());
            const categories = ref([]);
            const allCategories = ref([]); // Para o select, independente do mes
            const transactions = ref([]);
            
            // Modais
            const showTransactionModal = ref(false);
            const showCategoryModal = ref(false);

            // Formulários
            const newTransaction = ref({
                description: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                category_id: null,
                owner_type: 'both',
                is_installment: false,
                installments_total: 2
            });

            const newCategory = ref({
                name: '',
                budget_limit: '',
                color: '#3B82F6',
                valid_from: new Date().toISOString().split('T')[0],
                valid_until: null
            });

            // --- COMPUTEDS ---
            const currentMonthName = computed(() => {
                return currentDate.value.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            });

            const firstDayOfMonth = computed(() => {
                const date = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth(), 1);
                return date.toISOString().split('T')[0];
            });

            const lastDayOfMonth = computed(() => {
                const date = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 0);
