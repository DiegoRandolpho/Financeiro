<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Familiar</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS (Vers√£o UMD via UNPKG para maior estabilidade) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config para cores personalizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#3b82f6',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos globais e resets */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        /* Scrollbar hide for cleaner UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ==========================================
        
        // Chaves fornecidas
        const SUPABASE_URL = "https://ccktnhugjrgeafmialib.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg";
        
        let supabaseClient = null; // Vari√°vel para o cliente inicializado
        let initError = null;

        try {
            // 1. Tenta localizar a biblioteca globalmente (suporta varia√ß√µes de CDN: min√∫sculo ou mai√∫sculo)
            // Acessamos via 'window' para evitar conflito com vari√°veis locais
            const sbLib = window.supabase || window.Supabase;

            if (!sbLib || !sbLib.createClient) {
                throw new Error("A biblioteca do Supabase n√£o foi encontrada no objeto window. Verifique o script CDN.");
            }

            // 2. Limpeza e Valida√ß√£o
            const cleanUrl = SUPABASE_URL ? SUPABASE_URL.trim() : "";
            const cleanKey = SUPABASE_KEY ? SUPABASE_KEY.trim() : "";

            if (cleanUrl && cleanUrl.startsWith("http")) {
                // 3. Inicializa√ß√£o
                supabaseClient = sbLib.createClient(cleanUrl, cleanKey);
            } else {
                initError = "A URL do Supabase parece inv√°lida ou est√° vazia.";
            }
        } catch (error) {
            console.error("Erro cr√≠tico ao inicializar Supabase:", error);
            initError = error.message;
        }

        // Atalho para usar nos componentes
        const supabase = supabaseClient; 

        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // UTILIT√ÅRIOS
        // ==========================================
        
        const formatMoney = (val) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        };

        const formatDate = (dateStr) => {
            if(!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        };

        // Regra do Cart√£o: Vira dia 06.
        const getReferenceDate = (dateStr) => {
            const date = new Date(dateStr + 'T12:00:00');
            const day = date.getDate();
            const month = date.getMonth(); 
            const year = date.getFullYear();

            // Se for dia 1 a 6, pertence √† fatura do m√™s anterior
            if (day <= 6) {
                return new Date(year, month - 1, 1);
            }
            // Se for dia 7 em diante, pertence √† fatura deste m√™s
            return new Date(year, month, 1);
        };

        const getMonthName = (date) => {
            return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        };

        // ==========================================
        // COMPONENTES
        // ==========================================

        // --- TELA DE AVISO DE CONFIGURA√á√ÉO ---
        const SetupScreen = ({ error }) => (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
                    <div className="mb-4 flex justify-center text-red-500">
                        <i data-lucide="alert-triangle" className="w-12 h-12"></i>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">Erro de Inicializa√ß√£o</h1>
                    
                    <div className="bg-red-50 text-left p-4 rounded-lg text-sm text-red-800 space-y-2 mb-6 border border-red-200">
                        <p><strong>Detalhe do Erro:</strong></p>
                        <p className="font-mono text-xs break-all">{error || "Desconhecido"}</p>
                    </div>

                    <p className="text-gray-600 mb-4 text-sm">
                        O sistema n√£o conseguiu carregar as depend√™ncias necess√°rias.
                    </p>
                    
                    <button onClick={() => window.location.reload()} className="bg-primary text-white py-2 px-6 rounded-md hover:bg-slate-800 transition">
                        Recarregar P√°gina
                    </button>
                </div>
            </div>
        );

        // --- TELA DE LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [mode, setMode] = useState('login'); // login or signup

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    let result;
                    if (mode === 'signup') {
                        result = await supabase.auth.signUp({ email, password });
                    } else {
                        result = await supabase.auth.signInWithPassword({ email, password });
                    }

                    if (result.error) {
                        setError(result.error.message);
                    } else {
                        if (mode === 'signup') {
                            if (result.data?.user && !result.data.session) {
                                alert("Conta criada! Verifique seu email para confirmar o cadastro antes de logar.");
                            } else {
                                alert("Conta criada e logada!");
                            }
                        }
                    }
                } catch (err) {
                    setError("Erro de conex√£o. Verifique sua internet.");
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-primary mb-6">Finan√ßas Familiar üè°</h1>
                        {error && <div className="bg-red-100 text-red-600 p-3 rounded mb-4 text-sm">{error}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input required type="email" value={email} onChange={e => setEmail(e.target.value)} 
                                    className="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-accent focus:ring-accent"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Senha</label>
                                <input required type="password" value={password} onChange={e => setPassword(e.target.value)} 
                                    className="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-accent focus:ring-accent"/>
                            </div>
                            <button disabled={loading} className="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-slate-800 transition">
                                {loading ? 'Processando...' : (mode === 'login' ? 'Entrar' : 'Criar Conta')}
                            </button>
                        </form>
                        <div className="mt-4 text-center">
                            <button onClick={() => setMode(mode === 'login' ? 'signup' : 'login')} className="text-sm text-accent hover:underline">
                                {mode === 'login' ? 'N√£o tem conta? Cadastre-se' : 'J√° tem conta? Entrar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD (HOME) ---
        const Dashboard = ({ user, costCenters, expenses, currentMonthRef, onChangeMonth }) => {
            const monthlyExpenses = useMemo(() => {
                return expenses.filter(e => {
                    const refDate = getReferenceDate(e.date);
                    return refDate.getTime() === currentMonthRef.getTime();
                });
            }, [expenses, currentMonthRef]);

            const totalBudget = costCenters.reduce((acc, cc) => acc + (cc.active ? parseFloat(cc.budget) : 0), 0);
            const totalSpent = monthlyExpenses.reduce((acc, e) => acc + parseFloat(e.amount), 0);
            const percentTotal = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;

            const byCenter = costCenters.map(cc => {
                const spent = monthlyExpenses
                    .filter(e => e.cost_center_id === cc.id)
                    .reduce((acc, e) => acc + parseFloat(e.amount), 0);
                return { ...cc, spent, percent: cc.budget > 0 ? (spent / cc.budget) * 100 : 0 };
            }).sort((a,b) => b.percent - a.percent);

            const pieChartStyle = useMemo(() => {
                if (totalSpent === 0) return { background: '#e2e8f0' };
                let currentDeg = 0;
                const gradients = byCenter.map(cc => {
                    if (cc.spent <= 0) return '';
                    const deg = (cc.spent / totalSpent) * 360;
                    const str = `${cc.color} ${currentDeg}deg ${currentDeg + deg}deg`;
                    currentDeg += deg;
                    return str;
                }).filter(Boolean).join(', ');
                return { background: `conic-gradient(${gradients})` };
            }, [byCenter, totalSpent]);

            const shiftMonth = (offset) => {
                const newDate = new Date(currentMonthRef);
                newDate.setMonth(newDate.getMonth() + offset);
                onChangeMonth(newDate);
            };

            return (
                <div className="space-y-6 pb-20">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
                        <button onClick={() => shiftMonth(-1)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">‚Üê</button>
                        <div className="text-center">
                            <h2 className="text-sm text-gray-500 font-semibold">REFER√äNCIA</h2>
                            <h3 className="text-lg font-bold text-primary capitalize">{getMonthName(currentMonthRef)}</h3>
                        </div>
                        <button onClick={() => shiftMonth(1)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">‚Üí</button>
                    </div>

                    <div className="bg-primary text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                        <div className="relative z-10">
                            <p className="text-gray-300 text-sm">Total Gasto / Or√ßado</p>
                            <div className="flex items-end gap-2 mt-1">
                                <h2 className="text-3xl font-bold">{formatMoney(totalSpent)}</h2>
                                <span className="text-gray-400 mb-1 text-sm">/ {formatMoney(totalBudget)}</span>
                            </div>
                            <div className="w-full bg-gray-700 h-3 rounded-full mt-4 overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${percentTotal > 100 ? 'bg-red-500' : 'bg-accent'}`} 
                                     style={{ width: `${Math.min(percentTotal, 100)}%` }}></div>
                            </div>
                            <p className="text-right text-xs mt-1 text-gray-300">{percentTotal.toFixed(1)}% consumido</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-5 rounded-xl shadow-sm">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i data-lucide="pie-chart" className="w-4 h-4"></i> Distribui√ß√£o
                            </h3>
                            <div className="flex items-center gap-6">
                                <div className="w-24 h-24 rounded-full flex-shrink-0 border-4 border-gray-100" style={pieChartStyle}></div>
                                <div className="space-y-1 text-sm flex-1">
                                    {byCenter.slice(0, 4).map(cc => (
                                        <div key={cc.id} className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <span className="w-3 h-3 rounded-full" style={{backgroundColor: cc.color}}></span>
                                                <span className="text-gray-600 truncate max-w-[100px]">{cc.name}</span>
                                            </div>
                                            <span className="font-medium">{Math.round(cc.percent)}%</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-3">
                            <h3 className="font-bold text-gray-700 px-1">Detalhamento</h3>
                            {byCenter.map(cc => (
                                <div key={cc.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4" style={{borderLeftColor: cc.color}}>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="font-semibold text-gray-800">{cc.name}</span>
                                        <span className={`text-sm font-bold ${cc.spent > cc.budget ? 'text-red-500' : 'text-gray-600'}`}>
                                            {formatMoney(cc.spent)}
                                        </span>
                                    </div>
                                    <div className="flex justify-between text-xs text-gray-500 mb-2">
                                        <span>Or√ßamento: {formatMoney(cc.budget)}</span>
                                        <span>Restante: {formatMoney(cc.budget - cc.spent)}</span>
                                    </div>
                                    <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                        <div className={`h-full rounded-full ${cc.spent > cc.budget ? 'bg-red-500' : 'bg-green-500'}`}
                                             style={{width: `${Math.min(cc.percent, 100)}%`}}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- LAN√áAMENTOS (ADD & LIST) ---
        const ExpensesScreen = ({ costCenters, onAddExpense, expenses, user }) => {
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [centerId, setCenterId] = useState('');
            const [installments, setInstallments] = useState(1);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showForm, setShowForm] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);

                const baseDate = new Date(date);
                const promises = [];
                const valPerInstallment = parseFloat(amount) / installments;

                for (let i = 0; i < installments; i++) {
                    const instDate = new Date(baseDate);
                    instDate.setMonth(baseDate.getMonth() + i);
                    
                    promises.push(supabase.from('expenses').insert({
                        description: installments > 1 ? `${description} (${i+1}/${installments})` : description,
                        amount: valPerInstallment,
                        date: instDate.toISOString().split('T')[0],
                        cost_center_id: centerId,
                        user_email: user.email,
                        installment_current: i + 1,
                        installment_total: installments
                    }));
                }

                await Promise.all(promises);
                await onAddExpense(); 
                
                setIsSubmitting(false);
                setShowForm(false);
                setAmount('');
                setDescription('');
                setInstallments(1);
            };

            const recentExpenses = expenses.slice(0, 20); 

            return (
                <div className="pb-20 space-y-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Lan√ßamentos</h2>
                        <button onClick={() => setShowForm(!showForm)} className="bg-accent text-white p-2 rounded-full shadow-lg">
                            <i data-lucide={showForm ? "minus" : "plus"}></i>
                        </button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-5 rounded-xl shadow-md animate-fade-in">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="text-xs text-gray-500 font-bold uppercase">Valor</label>
                                    <input type="number" step="0.01" required value={amount} onChange={e => setAmount(e.target.value)} 
                                        className="w-full text-2xl font-bold border-b-2 border-gray-200 focus:border-accent outline-none py-2 text-gray-800" placeholder="R$ 0,00"/>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold uppercase">Descri√ß√£o</label>
                                    <input type="text" required value={description} onChange={e => setDescription(e.target.value)} 
                                        className="w-full border rounded p-2 text-sm" placeholder="Ex: Mercado Semanal"/>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-gray-500 font-bold uppercase">Data</label>
                                        <input type="date" required value={date} onChange={e => setDate(e.target.value)} 
                                            className="w-full border rounded p-2 text-sm"/>
                                        <p className="text-[10px] text-gray-400 mt-1">Virada dia 06</p>
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 font-bold uppercase">Centro de Custo</label>
                                        <select required value={centerId} onChange={e => setCenterId(e.target.value)} 
                                            className="w-full border rounded p-2 text-sm bg-white">
                                            <option value="">Selecione...</option>
                                            {costCenters.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold uppercase">Parcelas</label>
                                    <select value={installments} onChange={e => setInstallments(parseInt(e.target.value))} 
                                        className="w-full border rounded p-2 text-sm bg-white">
                                        <option value="1">√Ä vista (1x)</option>
                                        {[2,3,4,5,6,10,12].map(n => <option key={n} value={n}>{n}x</option>)}
                                    </select>
                                </div>
                                <button disabled={isSubmitting} className="w-full bg-primary text-white py-3 rounded-lg font-bold shadow hover:bg-slate-800">
                                    {isSubmitting ? 'Salvando...' : 'Adicionar Despesa'}
                                </button>
                            </form>
                        </div>
                    )}

                    <div className="space-y-2">
                        <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wide">√öltimos Gastos</h3>
                        {recentExpenses.length === 0 && <p className="text-gray-400 text-center py-4">Nenhum gasto registrado.</p>}
                        {recentExpenses.map(expense => {
                            const center = costCenters.find(c => c.id === expense.cost_center_id) || { color: '#ccc', name: 'Desconhecido' };
                            return (
                                <div key={expense.id} className="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between border-l-4" style={{borderLeftColor: center.color}}>
                                    <div className="flex-1 min-w-0 mr-2">
                                        <p className="font-semibold text-gray-800 truncate">{expense.description}</p>
                                        <div className="flex text-xs text-gray-500 gap-2">
                                            <span>{formatDate(expense.date)}</span>
                                            <span>‚Ä¢</span>
                                            <span className="truncate">{expense.user_email.split('@')[0]}</span>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-gray-800">{formatMoney(expense.amount)}</p>
                                        {expense.installment_total > 1 && (
                                            <span className="text-[10px] bg-blue-100 text-blue-700 px-1 rounded">
                                                {expense.installment_current}/{expense.installment_total}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- CENTROS DE CUSTO (CONFIG) ---
        const CostCentersScreen = ({ costCenters, onUpdate }) => {
            const [editing, setEditing] = useState(null);
            const [form, setForm] = useState({ name: '', budget: '', color: '#3b82f6' });

            const handleSave = async (e) => {
                e.preventDefault();
                if (editing) {
                    await supabase.from('cost_centers').update(form).eq('id', editing.id);
                } else {
                    await supabase.from('cost_centers').insert(form);
                }
                setEditing(null);
                setForm({ name: '', budget: '', color: '#3b82f6' });
                onUpdate();
            };

            const startEdit = (cc) => {
                setEditing(cc);
                setForm({ name: cc.name, budget: cc.budget, color: cc.color });
            };

            return (
                <div className="pb-20 space-y-4">
                    <h2 className="text-xl font-bold text-gray-800">Centros de Custo</h2>
                    
                    <div className="bg-white p-5 rounded-xl shadow-md">
                        <h3 className="text-sm font-bold text-gray-500 mb-3 uppercase">{editing ? 'Editar Centro' : 'Novo Centro'}</h3>
                        <form onSubmit={handleSave} className="grid gap-3">
                            <input placeholder="Nome (ex: Mercado)" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="border rounded p-2"/>
                            <div className="flex gap-2">
                                <input placeholder="Or√ßamento" type="number" required value={form.budget} onChange={e => setForm({...form, budget: e.target.value})} className="border rounded p-2 flex-1"/>
                                <input type="color" value={form.color} onChange={e => setForm({...form, color: e.target.value})} className="h-10 w-12 border rounded p-1 cursor-pointer"/>
                            </div>
                            <div className="flex gap-2">
                                <button className="bg-primary text-white flex-1 py-2 rounded font-medium">{editing ? 'Atualizar' : 'Criar'}</button>
                                {editing && <button type="button" onClick={() => { setEditing(null); setForm({ name: '', budget: '', color: '#3b82f6' }); }} className="bg-gray-200 text-gray-700 px-4 rounded">X</button>}
                            </div>
                        </form>
                    </div>

                    <div className="grid gap-3">
                        {costCenters.map(cc => (
                            <div key={cc.id} onClick={() => startEdit(cc)} className="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 border-l-4" style={{borderLeftColor: cc.color}}>
                                <div>
                                    <p className="font-bold text-gray-800">{cc.name}</p>
                                    <p className="text-sm text-gray-500">Or√ßamento: {formatMoney(cc.budget)}</p>
                                </div>
                                <i data-lucide="settings" className="w-4 h-4 text-gray-400"></i>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- CONTAS RECORRENTES ---
        const RecurrenceScreen = ({ costCenters, onUpdate, user }) => {
            const [recurrences, setRecurrences] = useState([]);
            const [form, setForm] = useState({ description: '', amount: '', cost_center_id: '', day_of_charge: 10 });
            
            const fetchRecurrences = async () => {
                const { data } = await supabase.from('recurrences').select('*').order('created_at');
                if (data) setRecurrences(data);
            };

            useEffect(() => { fetchRecurrences(); }, []);

            const handleAdd = async (e) => {
                e.preventDefault();
                await supabase.from('recurrences').insert(form);
                setForm({ description: '', amount: '', cost_center_id: '', day_of_charge: 10 });
                fetchRecurrences();
            };

            const toggleActive = async (id, currentVal) => {
                await supabase.from('recurrences').update({ active: !currentVal }).eq('id', id);
                fetchRecurrences();
            };

            const generateExpenses = async () => {
                const today = new Date();
                const monthStr = today.toISOString().slice(0, 7); 
                
                const confirmed = confirm(`Gerar despesas fixas para este m√™s (${monthStr})?`);
                if (!confirmed) return;

                const updates = recurrences.filter(r => r.active).map(r => {
                    const chargeDate = new Date(today.getFullYear(), today.getMonth(), r.day_of_charge || 10);
                    
                    return supabase.from('expenses').insert({
                        description: `[Fixo] ${r.description}`,
                        amount: r.amount,
                        date: chargeDate.toISOString().split('T')[0],
                        cost_center_id: r.cost_center_id,
                        user_email: user.email,
                        type: 'fixo',
                        is_recurrence: true
                    });
                });

                await Promise.all(updates);
                alert("Despesas geradas com sucesso!");
                onUpdate(); 
            };

            return (
                <div className="pb-20 space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-800">Contas Fixas</h2>
                        <button onClick={generateExpenses} className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">
                            Lan√ßar no M√™s
                        </button>
                    </div>

                    <form onSubmit={handleAdd} className="bg-white p-4 rounded-xl shadow-sm space-y-3">
                        <input placeholder="Descri√ß√£o (Ex: Aluguel)" required value={form.description} onChange={e => setForm({...form, description: e.target.value})} className="w-full border rounded p-2 text-sm"/>
                        <div className="flex gap-2">
                            <input placeholder="Valor" type="number" required value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="flex-1 border rounded p-2 text-sm"/>
                            <input placeholder="Dia" type="number" max="31" min="1" required value={form.day_of_charge} onChange={e => setForm({...form, day_of_charge: e.target.value})} className="w-16 border rounded p-2 text-sm"/>
                        </div>
                        <select required value={form.cost_center_id} onChange={e => setForm({...form, cost_center_id: e.target.value})} className="w-full border rounded p-2 text-sm bg-white">
                            <option value="">Centro de Custo...</option>
                            {costCenters.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>
                        <button className="w-full bg-secondary text-white py-2 rounded text-sm font-medium">Adicionar Recorr√™ncia</button>
                    </form>

                    <div className="space-y-2">
                        {recurrences.map(r => (
                            <div key={r.id} className={`bg-white p-3 rounded-lg shadow-sm flex items-center justify-between ${!r.active && 'opacity-50'}`}>
                                <div>
                                    <p className="font-bold text-gray-800">{r.description}</p>
                                    <p className="text-xs text-gray-500">Dia {r.day_of_charge} ‚Ä¢ {formatMoney(r.amount)}</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => toggleActive(r.id, r.active)} className={`w-10 h-6 rounded-full flex items-center p-1 transition-colors ${r.active ? 'bg-green-500' : 'bg-gray-300'}`}>
                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${r.active ? 'translate-x-4' : ''}`}></div>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('dashboard');
            const [costCenters, setCostCenters] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [currentMonthRef, setCurrentMonthRef] = useState(new Date(new Date().getFullYear(), new Date().getMonth(), 1)); 

            useEffect(() => {
                if (!supabase) return;

                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) loadData();
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) loadData();
                });

                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [view, session, expenses]);

            const loadData = async () => {
                if (!supabase) return;
                const [ccData, expData] = await Promise.all([
                    supabase.from('cost_centers').select('*').eq('active', true),
                    supabase.from('expenses').select('*').order('date', { ascending: false })
                ]);
                
                if (ccData.data) setCostCenters(ccData.data);
                if (expData.data) setExpenses(expData.data);
            };

            const handleLogout = async () => {
                if (supabase) await supabase.auth.signOut();
            };

            if (!supabase) return <SetupScreen error={initError} />;

            if (!session) return <LoginScreen />;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 relative shadow-2xl overflow-hidden">
                    <div className="h-full overflow-y-auto no-scrollbar pt-4 px-4">
                        {view === 'dashboard' && <Dashboard user={session.user} costCenters={costCenters} expenses={expenses} currentMonthRef={currentMonthRef} onChangeMonth={setCurrentMonthRef} />}
                        {view === 'expenses' && <ExpensesScreen user={session.user} costCenters={costCenters} expenses={expenses} onAddExpense={loadData} />}
                        {view === 'costcenters' && <CostCentersScreen costCenters={costCenters} onUpdate={loadData} />}
                        {view === 'recurrence' && <RecurrenceScreen user={session.user} costCenters={costCenters} onUpdate={loadData} />}
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center z-50">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center ${view === 'dashboard' ? 'text-primary' : 'text-gray-400'}`}>
                            <i data-lucide="pie-chart" className="w-6 h-6"></i>
                            <span className="text-[10px] mt-1">Vis√£o</span>
                        </button>
                        <button onClick={() => setView('expenses')} className={`flex flex-col items-center ${view === 'expenses' ? 'text-primary' : 'text-gray-400'}`}>
                            <i data-lucide="list" className="w-6 h-6"></i>
                            <span className="text-[10px] mt-1">Gastos</span>
                        </button>
                        
                        <div className="relative -top-5">
                            <button onClick={() => setView('expenses')} className="bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transform active:scale-95 transition">
                                <i data-lucide="plus" className="w-8 h-8"></i>
                            </button>
                        </div>

                        <button onClick={() => setView('recurrence')} className={`flex flex-col items-center ${view === 'recurrence' ? 'text-primary' : 'text-gray-400'}`}>
                            <i data-lucide="calendar" className="w-6 h-6"></i>
                            <span className="text-[10px] mt-1">Fixas</span>
                        </button>
                        <button onClick={() => setView('costcenters')} className={`flex flex-col items-center ${view === 'costcenters' ? 'text-primary' : 'text-gray-400'}`}>
                            <i data-lucide="wallet" className="w-6 h-6"></i>
                            <span className="text-[10px] mt-1">Centros</span>
                        </button>
                    </div>

                    <button onClick={handleLogout} className="absolute top-4 right-4 text-gray-400 hover:text-red-500">
                        <i data-lucide="log-out" className="w-5 h-5"></i>
                    </button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
