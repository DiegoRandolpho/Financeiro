<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance | Controle Profissional</title>
    
    <!-- Bibliotecas Base -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Fonte Inter para um visual mais clean -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        
        /* Custom Scrollbar para Dark Mode */
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class', // Habilita modo escuro via classe
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 850: '#172033', 900: '#0f172a', 950: '#020617' },
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased selection:bg-primary-100 selection:text-primary-700">

    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO ---
        const { useState, useEffect, useMemo } = React;
        const { createClient } = supabase;
        
        // SUAS CHAVES JÁ CONFIGURADAS
        const SUPABASE_URL = 'https://ccktnhugjrgeafmialib.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg';

        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ICONES (SVG INLINE) ---
        const Icons = {
            Wallet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            TrendingDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>,
            PiggyBank: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 5c-1.5 0-2.8.6-3.8 1.6l-2.1 2.2a.9.9 0 0 1-.7.3h-1.6a.9.9 0 0 1-.6-.3l-1.9-2A4.8 4.8 0 0 0 5 8.6v.1a.9.9 0 0 1-.3.7L2 11.1"/><path d="M15 15c-1.6 1.7-2.6 4-2.6 6.5a.5.5 0 0 0 .5.5h3.6a.5.5 0 0 0 .5-.5c0-1.8.6-3.4 1.7-4.8"/><path d="M19 19c-1.7-1.6-4-2.6-6.5-2.6a.5.5 0 0 0-.5.5v3.6a.5.5 0 0 0 .5.5c1.8 0 3.4-.6 4.8-1.7"/><circle cx="15.5" cy="8.5" r="2.5"/><path d="M7.5 16.5c-1.5 1.5-3.5 2.5-5.5 2.5"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            LayoutDashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Sun: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>,
            Trash: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Pencil: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            BarChart3: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            ArrowUpCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>,
            ArrowDownCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
        };

        // --- COMPONENTE DE UI: CARD ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm dark:shadow-slate-900/50 transition-all duration-300 ${className}`}>
                {children}
            </div>
        );

        // --- COMPONENTE DE UI: MODAL ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up relative border dark:border-slate-700">
                        <div className="flex justify-between items-center p-4 border-b border-slate-100 dark:border-slate-700">
                            <h3 className="font-bold text-slate-800 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:text-slate-400 dark:hover:text-slate-200 p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE DE UI: INPUT ---
        const Input = (props) => (
            <input 
                {...props}
                className={`w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/50 outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500 text-sm ${props.className || ''}`}
            />
        );

        // --- COMPONENTE DE UI: SELECT ---
        const Select = (props) => (
            <select
                {...props}
                className={`w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/50 outline-none transition-all text-sm appearance-none ${props.className || ''}`}
            >
                {props.children}
            </select>
        );

        // --- COMPONENTE DE UI: BOTÃO ---
        const Button = ({ children, variant = 'primary', className = "", ...props }) => {
            const variants = {
                primary: "bg-primary-600 hover:bg-primary-700 text-white shadow-sm hover:shadow dark:shadow-none",
                secondary: "bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700",
                danger: "bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 hover:bg-rose-100 dark:hover:bg-rose-900/40 border border-rose-200 dark:border-rose-800",
                ghost: "text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"
            };
            return (
                <button 
                    {...props}
                    className={`px-4 py-2.5 rounded-lg font-medium text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        // --- TELA DE LOGIN ---
        function Auth() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [isSignUp, setIsSignUp] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [successMsg, setSuccessMsg] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg('');
                setSuccessMsg('');
                
                let result = isSignUp 
                    ? await sb.auth.signUp({ email, password })
                    : await sb.auth.signInWithPassword({ email, password });

                if (result.error) {
                    setErrorMsg(result.error.message);
                } else if (isSignUp && !result.data.session) {
                    setSuccessMsg('Verifique seu e-mail para confirmar o cadastro.');
                }
                
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-950 p-4 transition-colors duration-300">
                    <Card className="w-full max-w-md p-8">
                        <div className="text-center mb-8">
                            <div className="w-12 h-12 bg-primary-100 dark:bg-primary-900/50 text-primary-600 dark:text-primary-400 rounded-xl flex items-center justify-center mx-auto mb-4">
                                <Icons.Wallet size={24} />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Finance</h2>
                            <p className="text-slate-500 dark:text-slate-400 text-sm mt-1">Gerencie suas finanças com inteligência</p>
                        </div>
                        
                        {errorMsg && (
                            <div className="mb-4 p-3 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-300 text-sm rounded-lg border border-rose-200 dark:border-rose-800 flex items-center gap-2">
                                <Icons.AlertTriangle size={16} /> {errorMsg}
                            </div>
                        )}

                        {successMsg && (
                            <div className="mb-4 p-3 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-300 text-sm rounded-lg border border-emerald-200 dark:border-emerald-800 flex items-center gap-2">
                                <Icons.CheckCircle2 size={16} /> {successMsg}
                            </div>
                        )}
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider mb-1.5">E-mail</label>
                                <Input type="email" placeholder="nome@exemplo.com" value={email} onChange={e => setEmail(e.target.value)} required />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider mb-1.5">Senha</label>
                                <Input type="password" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} required />
                            </div>
                            <Button className="w-full mt-2" disabled={loading}>
                                {loading ? 'Processando...' : (isSignUp ? 'Criar Conta' : 'Entrar')}
                            </Button>
                        </form>

                        <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                            <button onClick={() => setIsSignUp(!isSignUp)} className="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 font-medium">
                                {isSignUp ? 'Já tem conta? Fazer Login' : 'Não tem conta? Cadastre-se'}
                            </button>
                        </div>
                    </Card>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [session, setSession] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [currentMonth, setCurrentMonth] = useState(new Date().toISOString().slice(0, 7)); // Formato YYYY-MM
            const [editingId, setEditingId] = useState(null);
            const [selectedBudget, setSelectedBudget] = useState(null); // Estado para o orçamento selecionado para detalhes
            
            // Estado para Modais
            const [modals, setModals] = useState({ 
                income: false, 
                fixed: false, 
                budget: false, 
                variable: false,
                details: false // Modal de detalhes/extrato
            });

            // Estado para Confirmação de Exclusão
            const [deleteConfig, setDeleteConfig] = useState({ isOpen: false, table: '', id: '' });

            // Dados e Formulários
            const [data, setData] = useState({ incomes: [], fixed: [], budgets: [], variable: [] });
            const [forms, setForms] = useState({
                income: { description: '', amount: '', date: '' },
                fixed: { description: '', amount: '', start_date: '', end_date: '' },
                budget: { name: '', total_limit: '', start_date: '', end_date: '' }, // ADICIONADO CAMPOS DE DATA ORÇAMENTO
                variable: { description: '', amount: '', budget_id: '', date: '' }
            });

            // Efeito para Tema
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            useEffect(() => {
                sb.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchData();
                    else setLoading(false);
                });

                const { data: { subscription } } = sb.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) fetchData();
                });
                return () => subscription.unsubscribe();
            }, []);

            const fetchData = async () => {
                setLoading(true);
                // Busca TODOS os dados para filtrar no front
                const [inc, fix, bud, vary] = await Promise.all([
                    sb.from('incomes').select('*').order('date', { ascending: false }),
                    sb.from('fixed_expenses').select('*').order('start_date', { ascending: false }),
                    sb.from('budgets').select('*').order('created_at', { ascending: true }),
                    sb.from('variable_expenses').select('*').order('date', { ascending: false })
                ]);
                
                setData({ 
                    incomes: inc.data || [], 
                    fixed: fix.data || [], 
                    budgets: bud.data || [], 
                    variable: vary.data || [] 
                });
                setLoading(false);
            };

            const handleLogout = () => sb.auth.signOut();

            // Helpers de Form e Data
            const updateForm = (type, field, value) => {
                setForms(prev => ({ ...prev, [type]: { ...prev[type], [field]: value } }));
            };

            const toggleModal = (modalName, isOpen) => {
                setModals(prev => ({ ...prev, [modalName]: isOpen }));
                
                // Resetar ID de edição ao fechar ou abrir para novo cadastro
                if (isOpen && !editingId && modalName !== 'details') {
                    const today = new Date();
                    const selected = new Date(currentMonth + '-01');
                    let defaultDate = '';
                    if (today.toISOString().startsWith(currentMonth)) {
                         defaultDate = today.toISOString().slice(0, 10);
                    } else {
                         defaultDate = selected.toISOString().slice(0, 10);
                    }
                    
                    if(modalName === 'income') setForms(p => ({ ...p, income: { description: '', amount: '', date: defaultDate } }));
                    if(modalName === 'variable') setForms(p => ({ ...p, variable: { description: '', amount: '', budget_id: '', date: defaultDate } }));
                    if(modalName === 'fixed') setForms(p => ({ ...p, fixed: { description: '', amount: '', start_date: '', end_date: '' } }));
                    if(modalName === 'budget') setForms(p => ({ ...p, budget: { name: '', total_limit: '', start_date: defaultDate, end_date: '' } })); // DEFAULT DATA ORCAMENTO
                } else if (!isOpen) {
                    setTimeout(() => setEditingId(null), 300);
                }
            };

            const handleEdit = (type, item, modalName) => {
                setEditingId(item.id);
                // Preencher formulário com dados do item, tratando campos nulos
                const newForm = {};
                const template = forms[type];
                
                Object.keys(template).forEach(key => {
                    newForm[key] = item[key] !== null ? item[key] : '';
                });

                setForms(prev => ({ ...prev, [type]: newForm }));
                setModals(prev => ({ ...prev, [modalName]: true }));
            };

            const handleDelete = (table, id) => {
                setDeleteConfig({ isOpen: true, table, id });
            };

            const confirmDelete = async () => {
                if (!deleteConfig.id) return;
                await sb.from(deleteConfig.table).delete().eq('id', deleteConfig.id);
                setDeleteConfig({ isOpen: false, table: '', id: '' });
                fetchData();
            };

            const submitForm = async (table, formKey, payload, modalName) => {
                if (!session) return;
                
                // Tratamento de campos de data vazios para null
                const cleanPayload = { ...payload };
                if (cleanPayload.end_date === '') cleanPayload.end_date = null;

                if (editingId) {
                    await sb.from(table).update(cleanPayload).eq('id', editingId);
                } else {
                    await sb.from(table).insert([{ ...cleanPayload, user_id: session.user.id }]);
                }
                
                // Reset form
                const emptyForm = Object.keys(forms[formKey]).reduce((acc, key) => ({...acc, [key]: ''}), {});
                setForms(prev => ({ ...prev, [formKey]: emptyForm }));
                setEditingId(null);
                
                if(modalName) toggleModal(modalName, false);
                fetchData();
            };

            // --- LÓGICA DE FILTRAGEM POR MÊS ---
            const changeMonth = (offset) => {
                const date = new Date(currentMonth + '-02');
                date.setMonth(date.getMonth() + offset);
                setCurrentMonth(date.toISOString().slice(0, 7));
            };

            const formatMonthDisplay = (yyyyMm) => {
                const [year, month] = yyyyMm.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            };

            // Filtrar Dados Baseado no Mês Selecionado
            const filteredData = useMemo(() => {
                const incomes = data.incomes.filter(i => i.date.startsWith(currentMonth));
                const variable = data.variable.filter(v => v.date.startsWith(currentMonth));

                const monthStart = currentMonth + '-01';
                const monthEnd = currentMonth + '-31'; 
                
                const activeFixed = data.fixed.filter(f => {
                    const isActive = f.start_date <= monthEnd && (!f.end_date || f.end_date >= monthStart);
                    return isActive;
                });

                // NOVA LOGICA FILTRO ORÇAMENTOS POR DATA
                const activeBudgets = data.budgets.filter(b => {
                    // Se não tiver data de inicio no banco (legado), considera sempre ativo desde o começo
                    // Se tiver data, verifica se vigência cruza com o mês selecionado
                    const start = b.start_date || '2000-01-01'; 
                    const isActive = start <= monthEnd && (!b.end_date || b.end_date >= monthStart);
                    return isActive;
                });

                return { incomes, variable, fixed: activeFixed, budgets: activeBudgets };
            }, [data, currentMonth]);


            const getBudgetStats = (budgetId, limit) => {
                const spent = filteredData.variable
                    .filter(v => v.budget_id === budgetId)
                    .reduce((acc, curr) => acc + Number(curr.amount), 0);
                return { spent, remaining: limit - spent, percent: Math.min((spent / limit) * 100, 100) };
            };

            // Lista de gastos do orçamento selecionado (para o modal de detalhes)
            const selectedBudgetExpenses = useMemo(() => {
                if (!selectedBudget) return [];
                return filteredData.variable.filter(v => v.budget_id === selectedBudget.id).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [filteredData.variable, selectedBudget]);

            // --- TOTAIS DO DASHBOARD ---
            const totals = useMemo(() => {
                const income = filteredData.incomes.reduce((acc, curr) => acc + Number(curr.amount), 0);
                const fixed = filteredData.fixed.reduce((acc, curr) => acc + Number(curr.amount), 0);
                const variable = filteredData.variable.reduce((acc, curr) => acc + Number(curr.amount), 0);
                const totalExpenses = fixed + variable;
                const net = income - totalExpenses;
                
                return { income, fixed, variable, totalExpenses, net };
            }, [filteredData]);

            if (!session && !loading) {
                 return (
                    <div className={darkMode ? 'dark' : ''}>
                        <div className="absolute top-4 right-4 z-50">
                             <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm"
                            >
                                {darkMode ? <Icons.Sun size={20} /> : <Icons.Moon size={20} />}
                            </button>
                        </div>
                        <Auth />
                    </div>
                 );
            }
            
            if (loading && !session) return <div className="min-h-screen flex items-center justify-center text-slate-400 bg-slate-50 dark:bg-slate-950">Carregando...</div>;

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300 pb-20">
                        {/* HEADER */}
                        <header className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 transition-colors duration-300">
                            <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="bg-primary-600 text-white p-1.5 rounded-lg">
                                        <Icons.Wallet size={20} />
                                    </div>
                                    <h1 className="font-bold text-slate-800 dark:text-white text-lg tracking-tight">Finance</h1>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">{session?.user?.email}</span>
                                    <button 
                                        onClick={() => setDarkMode(!darkMode)}
                                        className="p-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                                    >
                                        {darkMode ? <Icons.Sun size={18} /> : <Icons.Moon size={18} />}
                                    </button>
                                    <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                                    <Button variant="ghost" onClick={handleLogout} className="!p-2 text-rose-500 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20">
                                        <Icons.LogOut size={18} />
                                    </Button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-5xl mx-auto px-4 py-8">
                            
                            {/* SELETOR DE MÊS */}
                            <div className="flex justify-center mb-8">
                                <div className="flex items-center bg-white dark:bg-slate-800 rounded-full shadow-sm border border-slate-200 dark:border-slate-700 p-1">
                                    <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                        <Icons.ChevronLeft size={20} />
                                    </button>
                                    <span className="px-6 font-semibold text-slate-800 dark:text-white capitalize min-w-[160px] text-center select-none">
                                        {formatMonthDisplay(currentMonth)}
                                    </span>
                                    <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                        <Icons.ChevronRight size={20} />
                                    </button>
                                </div>
                            </div>

                            {/* TABS DE NAVEGAÇÃO */}
                            <div className="flex flex-col sm:flex-row gap-4 mb-8">
                                <div className="flex p-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm w-full sm:w-auto transition-colors duration-300">
                                    {[
                                        { id: 'dashboard', label: 'Visão Geral', icon: Icons.BarChart3 },
                                        { id: 'entradas', label: 'Entradas', icon: Icons.TrendingUp },
                                        { id: 'fixos', label: 'Gastos Fixos', icon: Icons.Calendar },
                                        { id: 'orcamentos', label: 'Orçamentos', icon: Icons.PiggyBank }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2.5 rounded-lg text-sm font-medium transition-all ${
                                                activeTab === tab.id 
                                                    ? 'bg-primary-50 dark:bg-slate-700 text-primary-700 dark:text-white shadow-sm ring-1 ring-primary-200 dark:ring-slate-600' 
                                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700/50'
                                            }`}
                                        >
                                            <tab.icon size={16} />
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* CONTEÚDO */}
                            <div className="animate-fade-in">
                                
                                {/* --- ABA DASHBOARD --- */}
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {/* Card Entradas */}
                                            <Card className="p-6">
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="p-3 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400">
                                                        <Icons.ArrowUpCircle size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-slate-500 dark:text-slate-400">Entradas</p>
                                                        <h3 className="text-2xl font-bold text-slate-800 dark:text-white">R$ {totals.income.toFixed(2)}</h3>
                                                    </div>
                                                </div>
                                            </Card>

                                            {/* Card Gastos Fixos */}
                                            <Card className="p-6">
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="p-3 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                                                        <Icons.Calendar size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-slate-500 dark:text-slate-400">Gastos Fixos</p>
                                                        <h3 className="text-2xl font-bold text-slate-800 dark:text-white">R$ {totals.fixed.toFixed(2)}</h3>
                                                    </div>
                                                </div>
                                            </Card>

                                            {/* Card Gastos Variáveis */}
                                            <Card className="p-6">
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="p-3 rounded-full bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400">
                                                        <Icons.TrendingDown size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-slate-500 dark:text-slate-400">Gastos Variáveis</p>
                                                        <h3 className="text-2xl font-bold text-slate-800 dark:text-white">R$ {totals.variable.toFixed(2)}</h3>
                                                    </div>
                                                </div>
                                            </Card>

                                            {/* Card Líquido */}
                                            <Card className={`p-6 border-l-4 ${totals.net >= 0 ? 'border-l-emerald-500' : 'border-l-rose-500'}`}>
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className={`p-3 rounded-full ${totals.net >= 0 ? 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400' : 'bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400'}`}>
                                                        <Icons.Target size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-slate-500 dark:text-slate-400">Saldo Líquido</p>
                                                        <h3 className={`text-2xl font-bold ${totals.net >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>
                                                            R$ {totals.net.toFixed(2)}
                                                        </h3>
                                                    </div>
                                                </div>
                                            </Card>
                                        </div>

                                        {/* Barra de Distribuição */}
                                        <Card className="p-6">
                                            <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Distribuição de Gastos</h4>
                                            <div className="w-full h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden flex">
                                                <div 
                                                    className="h-full bg-blue-500" 
                                                    style={{ width: `${totals.totalExpenses > 0 ? (totals.fixed / totals.totalExpenses) * 100 : 0}%` }}
                                                    title={`Fixos: ${totals.totalExpenses > 0 ? ((totals.fixed / totals.totalExpenses) * 100).toFixed(1) : 0}%`}
                                                ></div>
                                                <div 
                                                    className="h-full bg-orange-500" 
                                                    style={{ width: `${totals.totalExpenses > 0 ? (totals.variable / totals.totalExpenses) * 100 : 0}%` }}
                                                    title={`Variáveis: ${totals.totalExpenses > 0 ? ((totals.variable / totals.totalExpenses) * 100).toFixed(1) : 0}%`}
                                                ></div>
                                            </div>
                                            <div className="flex justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                                    <span>Fixos ({totals.totalExpenses > 0 ? ((totals.fixed / totals.totalExpenses) * 100).toFixed(0) : 0}%)</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 rounded-full bg-orange-500"></div>
                                                    <span>Variáveis ({totals.totalExpenses > 0 ? ((totals.variable / totals.totalExpenses) * 100).toFixed(0) : 0}%)</span>
                                                </div>
                                            </div>
                                        </Card>
                                    </div>
                                )}
                                
                                {/* --- ABA ENTRADAS --- */}
                                {activeTab === 'entradas' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">Histórico de Entradas</h3>
                                            <div className="flex items-center gap-4">
                                                <span className="text-sm text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-1.5 rounded-lg shadow-sm">
                                                    Total: <strong className="text-slate-800 dark:text-slate-200">R$ {filteredData.incomes.reduce((a, b) => a + Number(b.amount), 0).toFixed(2)}</strong>
                                                </span>
                                                <Button onClick={() => { setEditingId(null); toggleModal('income', true); }}>
                                                    <Icons.Plus size={18} /> Nova Entrada
                                                </Button>
                                            </div>
                                        </div>
                                        
                                        <Modal 
                                            isOpen={modals.income} 
                                            onClose={() => toggleModal('income', false)}
                                            title={editingId ? "Editar Entrada" : "Nova Entrada"}
                                        >
                                            <div className="space-y-4">
                                                <Input 
                                                    placeholder="Descrição (ex: Salário)" 
                                                    value={forms.income.description} 
                                                    onChange={e => updateForm('income', 'description', e.target.value)} 
                                                />
                                                <div className="relative">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 text-sm">R$</span>
                                                    <Input 
                                                        type="number" 
                                                        placeholder="0,00" 
                                                        className="pl-9"
                                                        value={forms.income.amount} 
                                                        onChange={e => updateForm('income', 'amount', e.target.value)} 
                                                    />
                                                </div>
                                                <Input 
                                                    type="date" 
                                                    value={forms.income.date} 
                                                    onChange={e => updateForm('income', 'date', e.target.value)} 
                                                />
                                                <Button className="w-full" onClick={() => submitForm('incomes', 'income', forms.income, 'income')}>
                                                    {editingId ? "Salvar Alterações" : "Adicionar Entrada"}
                                                </Button>
                                            </div>
                                        </Modal>

                                        {filteredData.incomes.length === 0 ? (
                                            <div className="text-center py-12 bg-white dark:bg-slate-800/50 rounded-xl border border-dashed border-slate-300 dark:border-slate-700">
                                                <div className="text-slate-400 dark:text-slate-600 mb-2"><Icons.LayoutDashboard size={48} className="mx-auto opacity-50" /></div>
                                                <p className="text-slate-500 dark:text-slate-400">Nenhuma entrada neste mês.</p>
                                            </div>
                                        ) : (
                                            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                                {filteredData.incomes.map(inc => (
                                                    <Card key={inc.id} className="p-4 flex items-center justify-between group">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-10 h-10 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center">
                                                                <Icons.TrendingUp size={20} />
                                                            </div>
                                                            <div>
                                                                <p className="font-semibold text-slate-800 dark:text-slate-200">{inc.description}</p>
                                                                <p className="text-xs text-slate-500 dark:text-slate-400">{new Date(inc.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-col items-end gap-1">
                                                            <span className="font-bold text-emerald-600 dark:text-emerald-400 tabular-nums">
                                                                + R$ {Number(inc.amount).toFixed(2)}
                                                            </span>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleEdit('income', inc, 'income')} className="p-1 text-slate-400 hover:text-primary-500 transition-colors">
                                                                    <Icons.Pencil size={14} />
                                                                </button>
                                                                <button onClick={() => handleDelete('incomes', inc.id)} className="p-1 text-slate-400 hover:text-rose-500 transition-colors">
                                                                    <Icons.Trash size={14} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </Card>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* --- ABA FIXOS --- */}
                                {activeTab === 'fixos' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">Gastos Fixos</h3>
                                            <Button onClick={() => { setEditingId(null); toggleModal('fixed', true); }}>
                                                <Icons.Calendar size={18} /> Cadastrar Fixo
                                            </Button>
                                        </div>

                                        <Modal 
                                            isOpen={modals.fixed} 
                                            onClose={() => toggleModal('fixed', false)}
                                            title={editingId ? "Editar Gasto Fixo" : "Novo Gasto Fixo"}
                                        >
                                            <div className="space-y-4">
                                                <Input 
                                                    placeholder="Descrição (ex: Aluguel)"
                                                    value={forms.fixed.description}
                                                    onChange={e => updateForm('fixed', 'description', e.target.value)}
                                                />
                                                <div className="relative">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 text-sm">R$</span>
                                                    <Input 
                                                        type="number" 
                                                        className="pl-9"
                                                        placeholder="0,00"
                                                        value={forms.fixed.amount}
                                                        onChange={e => updateForm('fixed', 'amount', e.target.value)}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-slate-500 dark:text-slate-400 ml-1">Data Início</label>
                                                        <Input 
                                                            type="date"
                                                            value={forms.fixed.start_date}
                                                            onChange={e => updateForm('fixed', 'start_date', e.target.value)}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-slate-500 dark:text-slate-400 ml-1">Data Fim (Opcional)</label>
                                                        <Input 
                                                            type="date"
                                                            value={forms.fixed.end_date}
                                                            onChange={e => updateForm('fixed', 'end_date', e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                                <Button 
                                                    className="w-full"
                                                    onClick={() => submitForm('fixed_expenses', 'fixed', {
                                                        ...forms.fixed,
                                                        end_date: forms.fixed.end_date || null
                                                    }, 'fixed')}
                                                >
                                                    {editingId ? "Salvar Alterações" : "Cadastrar"}
                                                </Button>
                                            </div>
                                        </Modal>

                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-center">
                                                    <h4 className="font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                                                        <div className="w-2 h-2 rounded-full bg-rose-500"></div> Ativos em {formatMonthDisplay(currentMonth)}
                                                    </h4>
                                                    <span className="text-sm font-bold text-rose-600 dark:text-rose-400">
                                                        - R$ {filteredData.fixed.reduce((acc, curr) => acc + Number(curr.amount), 0).toFixed(2)}
                                                    </span>
                                                </div>
                                                
                                                {filteredData.fixed.length === 0 && <p className="text-sm text-slate-400 dark:text-slate-500 italic">Nenhum gasto fixo ativo neste mês.</p>}

                                                {filteredData.fixed.map(fix => (
                                                    <Card key={fix.id} className="p-4 flex justify-between items-center border-l-4 border-l-rose-500">
                                                        <div>
                                                            <p className="font-semibold text-slate-800 dark:text-slate-200">{fix.description}</p>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400">Desde: {new Date(fix.start_date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                                        </div>
                                                        <div className="flex flex-col items-end gap-1">
                                                            <span className="font-bold text-slate-700 dark:text-slate-300">R$ {Number(fix.amount).toFixed(2)}</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleEdit('fixed', fix, 'fixed')} className="p-1 text-slate-400 hover:text-primary-500 transition-colors">
                                                                    <Icons.Pencil size={14} />
                                                                </button>
                                                                <button onClick={() => handleDelete('fixed_expenses', fix.id)} className="p-1 text-slate-400 hover:text-rose-500 transition-colors">
                                                                    <Icons.Trash size={14} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </Card>
                                                ))}
                                            </div>
                                            
                                            <div className="space-y-4 opacity-70 hover:opacity-100 transition-opacity">
                                                <h4 className="font-bold text-slate-500 dark:text-slate-400 flex items-center gap-2">
                                                    <div className="w-2 h-2 rounded-full bg-slate-400"></div> Encerrados (Histórico)
                                                </h4>
                                                {data.fixed.filter(f => f.end_date && f.end_date < (currentMonth + '-01')).slice(0, 3).map(fix => (
                                                    <Card key={fix.id} className="p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                                        <div>
                                                            <p className="font-medium text-slate-600 dark:text-slate-400">{fix.description}</p>
                                                            <p className="text-xs text-slate-400 dark:text-slate-500">Fim: {new Date(fix.end_date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                                        </div>
                                                        <div className="flex flex-col items-end gap-1">
                                                            <span className="text-sm font-medium text-slate-500 dark:text-slate-500 line-through">R$ {Number(fix.amount).toFixed(2)}</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleEdit('fixed', fix, 'fixed')} className="p-1 text-slate-400 hover:text-primary-500 transition-colors">
                                                                    <Icons.Pencil size={14} />
                                                                </button>
                                                                <button onClick={() => handleDelete('fixed_expenses', fix.id)} className="p-1 text-slate-400 hover:text-rose-500 transition-colors">
                                                                    <Icons.Trash size={14} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </Card>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* --- ABA ORÇAMENTOS --- */}
                                {activeTab === 'orcamentos' && (
                                    <div>
                                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">Orçamentos & Gastos ({formatMonthDisplay(currentMonth)})</h3>
                                            <div className="flex gap-2 w-full sm:w-auto">
                                                <Button variant="secondary" onClick={() => { setEditingId(null); toggleModal('budget', true); }} className="flex-1 sm:flex-none">
                                                    <Icons.PiggyBank size={18} /> Novo Orçamento
                                                </Button>
                                                <Button onClick={() => { setEditingId(null); toggleModal('variable', true); }} className="flex-1 sm:flex-none bg-orange-600 hover:bg-orange-700">
                                                    <Icons.TrendingDown size={18} /> Novo Gasto
                                                </Button>
                                            </div>
                                        </div>

                                        <Modal 
                                            isOpen={modals.budget} 
                                            onClose={() => toggleModal('budget', false)}
                                            title={editingId ? "Editar Orçamento" : "Criar Orçamento"}
                                        >
                                            <div className="space-y-4">
                                                <Input 
                                                    placeholder="Nome (ex: Mercado)" 
                                                    value={forms.budget.name}
                                                    onChange={e => updateForm('budget', 'name', e.target.value)}
                                                />
                                                <div className="relative">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 text-sm">R$</span>
                                                    <Input 
                                                        type="number" 
                                                        className="pl-9"
                                                        placeholder="Limite Mensal" 
                                                        value={forms.budget.total_limit}
                                                        onChange={e => updateForm('budget', 'total_limit', e.target.value)}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-slate-500 dark:text-slate-400 ml-1">Data Início</label>
                                                        <Input 
                                                            type="date"
                                                            value={forms.budget.start_date}
                                                            onChange={e => updateForm('budget', 'start_date', e.target.value)}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-slate-500 dark:text-slate-400 ml-1">Data Fim (Opcional)</label>
                                                        <Input 
                                                            type="date"
                                                            value={forms.budget.end_date}
                                                            onChange={e => updateForm('budget', 'end_date', e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                                <Button className="w-full" onClick={() => submitForm('budgets', 'budget', forms.budget, 'budget')}>
                                                    {editingId ? "Salvar Alterações" : "Criar Orçamento"}
                                                </Button>
                                            </div>
                                        </Modal>

                                        <Modal 
                                            isOpen={modals.variable} 
                                            onClose={() => toggleModal('variable', false)}
                                            title={editingId ? "Editar Gasto" : "Lançar Gasto"}
                                        >
                                            <div className="space-y-4">
                                                <div className="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg border border-orange-100 dark:border-orange-900/40 mb-2">
                                                    <p className="text-xs text-orange-800 dark:text-orange-300">
                                                        Este gasto será registrado em: <strong>{formatMonthDisplay(currentMonth)}</strong>
                                                    </p>
                                                </div>
                                                <Select
                                                    value={forms.variable.budget_id}
                                                    onChange={e => updateForm('variable', 'budget_id', e.target.value)}
                                                >
                                                    <option value="">Selecione o Orçamento...</option>
                                                    {filteredData.budgets.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                                </Select>
                                                <Input 
                                                    placeholder="Descrição da Compra" 
                                                    value={forms.variable.description}
                                                    onChange={e => updateForm('variable', 'description', e.target.value)}
                                                />
                                                <div className="relative">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 text-sm">R$</span>
                                                    <Input 
                                                        type="number" 
                                                        className="pl-9"
                                                        placeholder="Valor da compra" 
                                                        value={forms.variable.amount}
                                                        onChange={e => updateForm('variable', 'amount', e.target.value)}
                                                    />
                                                </div>
                                                <Input 
                                                    type="date"
                                                    value={forms.variable.date}
                                                    onChange={e => updateForm('variable', 'date', e.target.value)}
                                                />
                                                <Button 
                                                    className="w-full bg-orange-600 hover:bg-orange-700 text-white" 
                                                    onClick={() => submitForm('variable_expenses', 'variable', forms.variable, 'variable')}
                                                >
                                                    {editingId ? "Salvar Alterações" : "Registrar Saída"}
                                                </Button>
                                            </div>
                                        </Modal>

                                        {/* Modal de Detalhes do Orçamento */}
                                        <Modal 
                                            isOpen={modals.details} 
                                            onClose={() => toggleModal('details', false)}
                                            title={selectedBudget ? `Extrato: ${selectedBudget.name}` : "Detalhes"}
                                        >
                                            <div className="space-y-4">
                                                <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg text-center text-sm text-slate-600 dark:text-slate-300">
                                                    Lançamentos de <strong>{formatMonthDisplay(currentMonth)}</strong>
                                                </div>
                                                
                                                {selectedBudgetExpenses.length === 0 ? (
                                                    <div className="text-center py-8 text-slate-400 dark:text-slate-500 italic">
                                                        Nenhum gasto lançado nesta categoria este mês.
                                                    </div>
                                                ) : (
                                                    <ul className="divide-y divide-slate-100 dark:divide-slate-700 max-h-[300px] overflow-y-auto pr-1">
                                                        {selectedBudgetExpenses.map(exp => (
                                                            <li key={exp.id} className="py-3 flex justify-between items-center group">
                                                                <div>
                                                                    <p className="font-medium text-slate-800 dark:text-slate-200">{exp.description}</p>
                                                                    <p className="text-xs text-slate-500 dark:text-slate-400">{new Date(exp.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                                                </div>
                                                                <div className="flex items-center gap-3">
                                                                    <span className="font-bold text-slate-700 dark:text-slate-300">R$ {Number(exp.amount).toFixed(2)}</span>
                                                                    <button 
                                                                        onClick={() => handleDelete('variable_expenses', exp.id)} 
                                                                        className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded transition-colors"
                                                                        title="Excluir lançamento"
                                                                    >
                                                                        <Icons.Trash size={14} />
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                )}
                                                <div className="pt-2 border-t border-slate-100 dark:border-slate-700 text-right">
                                                    <span className="text-sm text-slate-500 dark:text-slate-400 mr-2">Total Gasto:</span>
                                                    <span className="font-bold text-lg text-slate-800 dark:text-white">
                                                        R$ {selectedBudgetExpenses.reduce((acc, curr) => acc + Number(curr.amount), 0).toFixed(2)}
                                                    </span>
                                                </div>
                                            </div>
                                        </Modal>

                                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {filteredData.budgets.length === 0 && (
                                                 <div className="col-span-full text-center py-12 bg-white dark:bg-slate-800/50 rounded-xl border border-dashed border-slate-300 dark:border-slate-700">
                                                    <p className="text-slate-500 dark:text-slate-400">Crie seu primeiro orçamento para começar.</p>
                                                </div>
                                            )}
                                            {filteredData.budgets.map(b => {
                                                const { spent, remaining, percent } = getBudgetStats(b.id, b.total_limit);
                                                const isOver = remaining < 0;
                                                const barColor = isOver ? 'bg-rose-500' : (percent > 80 ? 'bg-orange-500' : 'bg-emerald-500');

                                                return (
                                                    <Card key={b.id} className="p-5 flex flex-col justify-between h-full">
                                                        <div>
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div>
                                                                    <h4 className="font-bold text-slate-800 dark:text-white text-lg">{b.name}</h4>
                                                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Limite: R$ {Number(b.total_limit).toFixed(2)}</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <span className={`block font-bold text-lg ${isOver ? 'text-rose-600 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-400'}`}>
                                                                        {isOver ? '-' : ''} R$ {Math.abs(remaining).toFixed(2)}
                                                                    </span>
                                                                    <div className="flex justify-end gap-1 mt-1">
                                                                        <button onClick={() => handleEdit('budget', b, 'budget')} className="p-1 text-slate-400 hover:text-primary-500 transition-colors">
                                                                            <Icons.Pencil size={14} />
                                                                        </button>
                                                                        <button onClick={() => handleDelete('budgets', b.id)} className="p-1 text-slate-400 hover:text-rose-500 transition-colors">
                                                                            <Icons.Trash size={14} />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className="relative h-4 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden mt-3">
                                                                <div 
                                                                    className={`h-full rounded-full ${barColor} progress-bar shadow-sm`}
                                                                    style={{ width: `${percent}%` }}
                                                                ></div>
                                                            </div>
                                                            <div className="flex justify-between mt-2 text-xs font-medium text-slate-500 dark:text-slate-400">
                                                                <span>Gasto em {formatMonthDisplay(currentMonth)}: R$ {spent.toFixed(2)}</span>
                                                                <span>{percent.toFixed(0)}% consumido</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                                            <button 
                                                                onClick={() => { setSelectedBudget(b); toggleModal('details', true); }}
                                                                className="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors font-medium"
                                                            >
                                                                <Icons.FileText size={16} /> Ver Extrato / Gerenciar
                                                            </button>
                                                        </div>
                                                    </Card>
                                                )
                                            })}
                                        </div>
                                    </div>
                                )}

                            </div>
                        </main>

                        {/* Modal de Confirmação de Exclusão */}
                        <Modal 
                            isOpen={deleteConfig.isOpen} 
                            onClose={() => setDeleteConfig({ ...deleteConfig, isOpen: false })}
                            title="Confirmar Exclusão"
                        >
                            <div className="space-y-4">
                                <p className="text-slate-600 dark:text-slate-300">
                                    Tem certeza que deseja excluir este item? Essa ação não pode ser desfeita.
                                </p>
                                <div className="flex gap-2 justify-end">
                                    <Button variant="ghost" onClick={() => setDeleteConfig({ ...deleteConfig, isOpen: false })}>
                                        Cancelar
                                    </Button>
                                    <Button variant="danger" onClick={confirmDelete}>
                                        Excluir
                                    </Button>
                                </div>
                            </div>
                        </Modal>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
