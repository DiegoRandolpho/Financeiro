<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanças Família</title>
    
    <!-- Bibliotecas via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- FontAwesome para ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .card-hover { transition: transform 0.2s; }
        .card-hover:hover { transform: translateY(-2px); }
        
        /* Spinner de Carregamento */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="app">

    <!-- TELA DE LOGIN -->
    <div v-if="!session" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full backdrop-blur-sm bg-opacity-95">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl">
                    <i class="fas fa-wallet"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Controle Familiar</h1>
                <p class="text-gray-500 text-sm">Conectado ao Supabase</p>
            </div>
            
            <div class="space-y-4">
                <input v-model="email" type="email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                <input v-model="password" type="password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                
                <div v-if="authError" class="text-red-500 text-sm text-center bg-red-50 p-2 rounded border border-red-100">
                    {{ authError }}
                </div>

                <button @click="handleLogin" :disabled="loading" class="w-full bg-gray-900 text-white p-3 rounded-lg hover:bg-gray-800 font-bold shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                    <span v-if="loading" class="loader"></span>
                    <span>{{ isSignUp ? 'Criar Conta' : 'Entrar' }}</span>
                </button>
                
                <div class="text-center mt-4">
                    <button @click="isSignUp = !isSignUp" class="text-blue-600 text-sm hover:underline">
                        {{ isSignUp ? 'Já tem conta? Entrar' : 'Não tem conta? Cadastrar' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div v-else class="min-h-screen flex flex-col pb-24 sm:pb-0">
        
        <!-- HEADER -->
        <header class="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-100">
            <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white text-sm">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800 leading-tight">Finanças</h1>
                        <p class="text-[10px] text-green-600 font-semibold bg-green-100 px-1 rounded inline-block">CONECTADO</p>
                    </div>
                </div>

                <!-- Seletor de Mês -->
                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                    <button @click="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white hover:shadow-sm rounded-md transition">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
                    <span class="font-mono text-sm font-bold text-gray-700 w-24 text-center select-none">{{ currentMonthName }}</span>
                    <button @click="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white hover:shadow-sm rounded-md transition">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>

                <button @click="logout" class="text-gray-400 hover:text-red-500 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- CONTEÚDO -->
        <main class="flex-1 max-w-5xl w-full mx-auto p-4 space-y-6">
            
            <!-- LOADING STATE -->
            <div v-if="loadingData" class="flex justify-center py-10">
                <div class="loader border-blue-500 w-10 h-10"></div>
            </div>

            <div v-else>
                <!-- RESUMO (CARDS) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Orçado -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i class="fas fa-bullseye"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Orçamento</span>
                        </div>
                        <p class="text-2xl font-bold text-gray-800">R$ {{ formatMoney(totalBudget) }}</p>
                    </div>

                    <!-- Gasto -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-red-50 rounded-lg text-red-600"><i class="fas fa-money-bill-wave"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Realizado</span>
                        </div>
                        <p class="text-2xl font-bold text-gray-800">R$ {{ formatMoney(totalSpent) }}</p>
                    </div>

                    <!-- Saldo -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex justify-between items-start mb-2">
                            <div :class="totalBudget - totalSpent >= 0 ? 'bg-green-50 text-green-600' : 'bg-orange-50 text-orange-600'" class="p-2 rounded-lg">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Disponível</span>
                        </div>
                        <p :class="totalBudget - totalSpent >= 0 ? 'text-green-600' : 'text-red-500'" class="text-2xl font-bold">
                            R$ {{ formatMoney(totalBudget - totalSpent) }}
                        </p>
                    </div>
                </div>

                <!-- FILTRO DE VISUALIZAÇÃO -->
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide mb-4">
                    <button 
                        v-for="filter in ['all', 'me', 'her', 'both']" 
                        @click="activeFilter = filter"
                        :class="activeFilter === filter ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'"
                        class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors">
                        {{ getFilterLabel(filter) }}
                    </button>
                </div>

                <!-- LISTA DE CATEGORIAS -->
                <div class="space-y-4">
                    <div v-for="cat in filteredCategories" :key="cat.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <!-- Detalhes do Topo -->
                        <div class="flex justify-between items-end mb-3 relative z-10">
                            <div class="flex items-center gap-3">
                                <div :style="{ backgroundColor: cat.color + '20', color: cat.color }" class="w-10 h-10 rounded-full flex items-center justify-center text-lg">
                                    <i class="fas fa-tag"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">{{ cat.name }}</h3>
                                    <p class="text-xs text-gray-500">{{ cat.transactionCount }} lançamentos</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-sm font-bold block" :class="getBudgetColor(cat.spent, cat.budget_limit)">
                                    R$ {{ formatMoney(cat.spent) }}
                                </span>
                                <span class="text-xs text-gray-400">de R$ {{ formatMoney(cat.budget_limit) }}</span>
                            </div>
                        </div>

                        <!-- Barra de Progresso -->
                        <div class="w-full bg-gray-100 rounded-full h-3 mb-1 overflow-hidden">
                            <div class="progress-bar h-3 rounded-full relative" 
                                 :style="{ width: getPercentage(cat.spent, cat.budget_limit) + '%', backgroundColor: cat.color }">
                            </div>
                        </div>
                        
                        <!-- Aviso de estouro -->
                        <div v-if="cat.spent > cat.budget_limit" class="flex justify-end">
                            <span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full">
                                Excedido em R$ {{ formatMoney(cat.spent - cat.budget_limit) }}
                            </span>
                        </div>

                        <!-- Botão para ver detalhes (Expandir) -->
                        <button @click="toggleDetails(cat.id)" class="w-full mt-2 text-xs text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1 py-1 border-t border-gray-50 mt-3">
                            <span v-if="expandedCat === cat.id">Ocultar Detalhes</span>
                            <span v-else>Ver Lançamentos</span>
                            <i :class="expandedCat === cat.id ? 'fa-chevron-up' : 'fa-chevron-down'" class="fas"></i>
                        </button>

                        <!-- Lista de Transações da Categoria (Expandido) -->
                        <div v-if="expandedCat === cat.id" class="mt-2 bg-gray-50 rounded-lg p-3 space-y-2 text-sm animate-fade-in">
                            <div v-for="t in getTransactionsByCategory(cat.id)" :key="t.id" class="flex justify-between items-center border-b border-gray-100 last:border-0 pb-2 last:pb-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-mono text-gray-400">{{ formatDateDay(t.date) }}</span>
                                    <span class="text-gray-700">{{ t.description }}</span>
                                    <span v-if="t.owner_type === 'me'" class="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded">Eu</span>
                                    <span v-if="t.owner_type === 'her'" class="text-[10px] bg-pink-100 text-pink-700 px-1.5 rounded">Ela</span>
                                    <span v-if="t.installment_total" class="text-[10px] bg-gray-200 text-gray-600 px-1.5 rounded">{{t.installment_current}}/{{t.installment_total}}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-gray-700">R$ {{ formatMoney(t.amount) }}</span>
                                    <!-- Botão Deletar (Pequeno lixo) -->
                                    <button @click="deleteTransaction(t.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div v-if="getTransactionsByCategory(cat.id).length === 0" class="text-center text-gray-400 py-2 text-xs">
                                Nenhum lançamento neste mês.
                            </div>
                        </div>

                    </div>

                    <!-- Empty State -->
                    <div v-if="categories.length === 0" class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300">
                        <div class="text-gray-300 text-4xl mb-3"><i class="fas fa-ghost"></i></div>
                        <p class="text-gray-500">Nenhuma categoria encontrada.</p>
                        <p class="text-xs text-gray-400 mt-1">Crie um orçamento para começar.</p>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTÕES FLUTUANTES (FAB) -->
        <div class="fixed bottom-6 right-6 flex flex-col items-end gap-3 z-30">
            <div v-if="showFabMenu" class="absolute bottom-20 right-0 flex flex-col gap-3 items-end w-48 pointer-events-none">
                <span class="bg-gray-800 text-white text-xs py-1 px-2 rounded opacity-0 transition-opacity" :class="{'opacity-100': showFabMenu}">Nova Categoria</span>
                <span class="bg-blue-600 text-white text-xs py-1 px-2 rounded opacity-0 transition-opacity" :class="{'opacity-100': showFabMenu}">Novo Gasto</span>
            </div>

            <button v-if="showFabMenu" @click="openModal('category')" class="bg-gray-800 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition mb-1">
                <i class="fas fa-tags"></i>
            </button>
            
            <button v-if="showFabMenu" @click="openModal('transaction')" class="bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition">
                <i class="fas fa-dollar-sign"></i>
            </button>

            <button @click="showFabMenu = !showFabMenu" 
                    :class="showFabMenu ? 'rotate-45 bg-red-500' : 'bg-blue-600'"
                    class="text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-xl transition-transform duration-300">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- MODAL: NOVA TRANSAÇÃO -->
        <div v-if="modalType === 'transaction'" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                    <h3 class="font-bold text-lg"><i class="fas fa-receipt mr-2"></i>Novo Gasto</h3>
                    <button @click="closeModal" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Valor -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-400">R$</span>
                            <input v-model="newTransaction.amount" type="number" step="0.01" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-lg text-lg font-bold text-gray-800 focus:bg-white focus:border-blue-500 outline-none" placeholder="0,00">
                        </div>
                    </div>

                    <!-- Descrição -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                        <input v-model="newTransaction.description" type="text" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-blue-500 outline-none" placeholder="Ex: Jantar Fora">
                    </div>

                    <!-- Data e Categoria -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                            <input v-model="newTransaction.date" type="date" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoria</label>
                            <select v-model="newTransaction.category_id" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm bg-white">
                                <option :value="null">Selecione...</option>
                                <option v-for="c in allCategories" :value="c.id">{{ c.name }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Responsável -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Quem gastou?</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="newTransaction.owner_type = 'me'" :class="newTransaction.owner_type === 'me' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200'" class="p-2 border rounded-lg text-sm font-semibold transition">Eu</button>
                            <button @click="newTransaction.owner_type = 'her'" :class="newTransaction.owner_type === 'her' ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-500 border-gray-200'" class="p-2 border rounded-lg text-sm font-semibold transition">Ela</button>
                            <button @click="newTransaction.owner_type = 'both'" :class="newTransaction.owner_type === 'both' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-500 border-gray-200'" class="p-2 border rounded-lg text-sm font-semibold transition">Ambos</button>
                        </div>
                    </div>

                    <!-- Parcelamento -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" v-model="newTransaction.is_installment" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-green-400"/>
                                <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Parcelar compra?</span>
                        </label>
                        
                        <div v-if="newTransaction.is_installment" class="mt-3 animate-fade-in">
                            <label class="block text-xs text-gray-500 mb-1">Número de parcelas (2x a 24x)</label>
                            <div class="flex items-center gap-2">
                                <input v-model="newTransaction.installments_total" type="range" min="2" max="24" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <span class="bg-white border px-3 py-1 rounded font-mono font-bold">{{ newTransaction.installments_total }}x</span>
                            </div>
                            <p class="text-[10px] text-orange-600 mt-2">
                                <i class="fas fa-exclamation-triangle"></i> Serão lançados {{ formatMoney(newTransaction.amount / newTransaction.installments_total) }} nos próximos {{ newTransaction.installments_total }} meses.
                            </p>
                        </div>
                    </div>

                    <button @click="saveTransaction" :disabled="saving" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-lg transition transform active:scale-95 mt-4 flex justify-center items-center gap-2">
                        <span v-if="saving" class="loader !w-5 !h-5 !border-white !border-t-transparent"></span>
                        <span>{{ saving ? 'Salvando...' : 'Confirmar Gasto' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL: NOVA CATEGORIA -->
        <div v-if="modalType === 'category'" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="bg-gray-800 p-4 text-white flex justify-between items-center">
                    <h3 class="font-bold text-lg"><i class="fas fa-chart-pie mr-2"></i>Novo Orçamento</h3>
                    <button @click="closeModal" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Centro de Custo</label>
                        <input v-model="newCategory.name" type="text" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-gray-800 outline-none" placeholder="Ex: Mercado, Combustível...">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Limite Mensal (Budget)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-400">R$</span>
                            <input v-model="newCategory.budget_limit" type="number" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-lg font-bold text-gray-800 focus:bg-white outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cor</label>
                        <div class="flex gap-2 flex-wrap">
                            <button v-for="color in presetColors" :key="color" 
                                @click="newCategory.color = color"
                                :style="{backgroundColor: color}"
                                :class="{'ring-2 ring-offset-2 ring-gray-400': newCategory.color === color}"
                                class="w-8 h-8 rounded-full transition-all hover:scale-110">
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Vigência</label>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <span class="text-[10px] text-gray-400 block mb-1">Início</span>
                                <input v-model="newCategory.valid_from" type="date" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-xs">
                            </div>
                            <div class="flex-1">
                                <span class="text-[10px] text-gray-400 block mb-1">Fim (Opcional)</span>
                                <input v-model="newCategory.valid_until" type="date" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-xs">
                            </div>
                        </div>
                    </div>

                    <button @click="saveCategory" :disabled="saving" class="w-full bg-gray-800 text-white p-4 rounded-xl font-bold text-lg hover:bg-black shadow-lg transition transform active:scale-95 mt-2 flex justify-center items-center gap-2">
                        <span v-if="saving" class="loader !w-5 !h-5 !border-white !border-t-transparent"></span>
                        <span>{{ saving ? 'Criando...' : 'Criar Categoria' }}</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

<script>
    const { createClient } = supabase;
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- CONFIG SUPABASE (Inserido pelo usuário) ---
    const SUPABASE_URL = 'https://ccktnhugjrgeafmialib.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg';
    
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
        setup() {
            // -- ESTADO --
            const session = ref(null);
            const email = ref('');
            const password = ref('');
            const isSignUp = ref(false); // Alternar entre Login e Cadastro
            const authError = ref('');
            const loading = ref(false); // Loading Auth
            const loadingData = ref(false); // Loading Fetch
            const saving = ref(false); // Loading Save

            const showFabMenu = ref(false);
            const modalType = ref(null);
            const expandedCat = ref(null);
            const activeFilter = ref('all'); // all, me, her, both

            const currentDate = ref(new Date());
            
            // Dados Reais
            const categories = ref([]);
            const transactions = ref([]);
            const allCategories = ref([]); // Lista bruta sem filtro de data

            // Formulários
            const newTransaction = ref({
                description: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                category_id: null,
                owner_type: 'both',
                is_installment: false,
                installments_total: 2
            });

            const newCategory = ref({
                name: '',
                budget_limit: '',
                color: '#3B82F6',
                valid_from: new Date().toISOString().split('T')[0],
                valid_until: null
            });

            const presetColors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#64748b'];

            // -- COMPUTEDS --
            const currentMonthName = computed(() => {
                return currentDate.value.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
            });

            const firstDayOfMonth = computed(() => {
                const d = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth(), 1);
                return d.toISOString().split('T')[0];
            });

            const lastDayOfMonth = computed(() => {
                const d = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 0);
                return d.toISOString().split('T')[0];
            });

            // Processamento dos dados para exibição
            const filteredCategories = computed(() => {
                // 1. Filtra transações apenas deste mês
                const currentMonthTrans = transactions.value.filter(t => {
                    return t.date >= firstDayOfMonth.value && t.date <= lastDayOfMonth.value;
                });

                // 2. Mapeia categorias adicionando o "spent"
                // A lista 'categories' já vem filtrada do backend pela vigência
                return categories.value.map(cat => {
                    let catTrans = currentMonthTrans.filter(t => t.category_id === cat.id);

                    // Filtro de Responsável
                    if (activeFilter.value !== 'all') {
                        catTrans = catTrans.filter(t => t.owner_type === activeFilter.value);
                    }

                    const spent = catTrans.reduce((acc, t) => acc + Number(t.amount), 0);
                    
                    return {
                        ...cat,
                        spent,
                        transactionCount: catTrans.length
                    };
                });
            });

            const totalBudget = computed(() => {
                return filteredCategories.value.reduce((acc, cat) => acc + Number(cat.budget_limit), 0);
            });

            const totalSpent = computed(() => {
                return filteredCategories.value.reduce((acc, cat) => acc + cat.spent, 0);
            });

            // -- ACTIONS --

            const handleLogin = async () => {
                loading.value = true;
                authError.value = '';
                
                let error = null;
                let data = null;

                if (isSignUp.value) {
                    const res = await _supabase.auth.signUp({ email: email.value, password: password.value });
                    error = res.error;
                    data = res.data;
                    if (!error && data.user) {
                         alert('Conta criada! Verifique se recebeu um email de confirmação ou se o login já foi autorizado.');
                         // Auto login as vezes funciona direto dependendo da config do Supabase
                    }
                } else {
                    const res = await _supabase.auth.signInWithPassword({ email: email.value, password: password.value });
                    error = res.error;
                    data = res.data;
                }

                if (error) {
                    authError.value = error.message;
                } else {
                    session.value = data.session;
                    fetchData();
                }
                loading.value = false;
            };

            const logout = async () => {
                await _supabase.auth.signOut();
                session.value = null;
                categories.value = [];
                transactions.value = [];
            };

            const fetchData = async () => {
                if (!session.value) return;
                loadingData.value = true;

                try {
                    // 1. Buscar Categorias vigentes
                    // Regra: valid_from <= fim_do_mes E (valid_until NULL ou valid_until >= inicio_do_mes)
                    const { data: cats, error: catError } = await _supabase
                        .from('categories')
                        .select('*')
                        .lte('valid_from', lastDayOfMonth.value)
                        .or(`valid_until.is.null,valid_until.gte.${firstDayOfMonth.value}`);

                    if (catError) throw catError;
                    categories.value = cats || [];

                    // Buscar TODAS categorias para o select (mesmo antigas)
                    const { data: allCats } = await _supabase.from('categories').select('*');
                    allCategories.value = allCats || [];

                    // 2. Buscar Transações do mês
                    const { data: trans, error: transError } = await _supabase
                        .from('transactions')
                        .select('*')
                        .gte('date', firstDayOfMonth.value)
                        .lte('date', lastDayOfMonth.value);

                    if (transError) throw transError;
                    transactions.value = trans || [];

                } catch (e) {
                    console.error("Erro ao buscar dados:", e);
                    alert("Erro ao carregar dados. Veja o console.");
                } finally {
                    loadingData.value = false;
                }
            };

            const saveCategory = async () => {
                if (!newCategory.value.name) return alert('Nome é obrigatório');
                saving.value = true;

                const payload = {
                    ...newCategory.value,
                    user_id: session.value.user.id
                };
                if(payload.valid_until === '') payload.valid_until = null;

                const { error } = await _supabase.from('categories').insert(payload);

                if (error) {
                    alert('Erro ao salvar: ' + error.message);
                } else {
                    closeModal();
                    fetchData(); // Recarrega
                    // Reset
                    newCategory.value.name = '';
                    newCategory.value.budget_limit = '';
                }
                saving.value = false;
            };

            const saveTransaction = async () => {
                if (!newTransaction.value.category_id || !newTransaction.value.amount) return alert('Preencha os dados');
                saving.value = true;

                const baseDate = new Date(newTransaction.value.date);
                const toInsert = [];

                if (newTransaction.value.is_installment) {
                    const totalParcelas = Number(newTransaction.value.installments_total);
                    const valorParcela = Number(newTransaction.value.amount) / totalParcelas;

                    for (let i = 0; i < totalParcelas; i++) {
                        const d = new Date(baseDate);
                        d.setMonth(baseDate.getMonth() + i);
                        
                        toInsert.push({
                            description: `${newTransaction.value.description}`,
                            amount: valorParcela,
                            date: d.toISOString().split('T')[0],
                            category_id: newTransaction.value.category_id,
                            user_id: session.value.user.id,
                            owner_type: newTransaction.value.owner_type,
                            is_installment: true,
                            installment_current: i + 1,
                            installment_total: totalParcelas
                        });
                    }
                } else {
                    toInsert.push({
                        description: newTransaction.value.description,
                        amount: newTransaction.value.amount,
                        date: newTransaction.value.date,
                        category_id: newTransaction.value.category_id,
                        user_id: session.value.user.id,
                        owner_type: newTransaction.value.owner_type,
                        is_installment: false
                    });
                }

                const { error } = await _supabase.from('transactions').insert(toInsert);

                if (error) {
                    alert('Erro ao salvar transação: ' + error.message);
                } else {
                    closeModal();
                    fetchData();
                    // Reset parcial
                    newTransaction.value.description = '';
                    newTransaction.value.amount = '';
                }
                saving.value = false;
            };

            const deleteTransaction = async (id) => {
                if(!confirm("Deseja deletar este lançamento?")) return;
                
                const { error } = await _supabase.from('transactions').delete().eq('id', id);
                if(error) alert("Erro ao deletar");
                else fetchData();
            }

            // --- HELPERS UI ---
            const changeMonth = (delta) => {
                const newDate = new Date(currentDate.value);
                newDate.setMonth(newDate.getMonth() + delta);
                currentDate.value = newDate;
                fetchData();
            };

            const formatMoney = (val) => Number(val).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const formatDateDay = (dateStr) => { const [y, m, d] = dateStr.split('-'); return `${d}/${m}`; };
            const getPercentage = (spent, budget) => (!budget) ? 0 : Math.min((spent / budget) * 100, 100);
            
            const getBudgetColor = (spent, budget) => {
                const pct = (spent / budget) * 100;
                if (pct > 100) return 'text-red-600';
                if (pct > 85) return 'text-orange-500';
                return 'text-green-600';
            };
            
            const getFilterLabel = (f) => ({ 'all': 'Todos', 'me': 'Meus', 'her': 'Dela', 'both': 'Compartilhado' }[f]);

            const getTransactionsByCategory = (catId) => {
                return transactions.value
                    .filter(t => t.category_id === catId && t.date >= firstDayOfMonth.value && t.date <= lastDayOfMonth.value)
                    .sort((a,b) => new Date(b.date) - new Date(a.date));
            };

            const toggleDetails = (catId) => expandedCat.value = (expandedCat.value === catId) ? null : catId;
            const openModal = (type) => { modalType.value = type; showFabMenu.value = false; };
            const closeModal = () => modalType.value = null;

            // --- LIFECYCLE ---
            onMounted(() => {
                // Checa se já tem sessão ativa
                _supabase.auth.getSession().then(({ data }) => {
                    session.value = data.session;
                    if (session.value) fetchData();
                });

                // Ouve mudanças de auth
                _supabase.auth.onAuthStateChange((_event, _session) => {
                    session.value = _session;
                    if(_session) fetchData();
                });
            });

            return {
                session, email, password, isSignUp, authError, loading, handleLogin, logout,
                loadingData, saving,
                currentDate, currentMonthName, changeMonth,
                totalBudget, totalSpent, filteredCategories, allCategories,
                formatMoney, formatDateDay, getPercentage, getBudgetColor,
                showFabMenu, modalType, openModal, closeModal,
                activeFilter, getFilterLabel,
                expandedCat, toggleDetails, getTransactionsByCategory,
                newTransaction, newCategory, presetColors,
                saveTransaction, saveCategory, deleteTransaction
            };
        }
    }).mount('#app');
</script>

<style>
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .toggle-checkbox:checked { right: 0; border-color: #10b981; }
    .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
</style>
</body>
</html>
