<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Casal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        /* Estilo das Abas */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #e0e0e0; border-radius: 5px; font-weight: bold; }
        .tab-btn.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }

        /* Formul치rios e Listas */
        .input-group { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 1; }
        button.add-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        
        .item-list { list-style: none; padding: 0; }
        .item-list li { background: white; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .orcamento-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #007bff; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>游눯 Controle Financeiro</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('receitas')">Entradas</button>
        <button class="tab-btn" onclick="openTab('fixos')">Gastos Fixos</button>
        <button class="tab-btn" onclick="openTab('orcamentos')">Vari치veis / Or칞amentos</button>
    </div>

    <div id="receitas" class="tab-content active">
        <div class="input-group">
            <select id="recTipo">
                <option value="Salario A">Sal치rio A</option>
                <option value="Salario B">Sal치rio B</option>
                <option value="Extras">Extras</option>
            </select>
            <input type="text" id="recDesc" placeholder="Descri칞칚o (ex: B칪nus)">
            <input type="number" id="recValor" placeholder="Valor (R$)">
            <button class="add-btn" onclick="addReceita()">+ Adicionar</button>
        </div>
        <h3>Hist칩rico de Entradas</h3>
        <ul id="listaReceitas" class="item-list">Carregando...</ul>
    </div>

    <div id="fixos" class="tab-content">
        <div class="input-group">
            <input type="text" id="fixDesc" placeholder="Descri칞칚o (ex: Aluguel)">
            <input type="number" id="fixValor" placeholder="Valor (R$)">
            <div style="display:flex; flex-direction:column; gap:2px; flex:1">
                <small>In칤cio</small>
                <input type="date" id="fixInicio">
            </div>
            <div style="display:flex; flex-direction:column; gap:2px; flex:1">
                <small>Fim (Opcional)</small>
                <input type="date" id="fixFim">
            </div>
            <button class="add-btn" onclick="addFixo()">+ Salvar</button>
        </div>
        <h3>Contas Ativas</h3>
        <ul id="listaFixos" class="item-list">Carregando...</ul>
    </div>

    <div id="orcamentos" class="tab-content">
        <div class="input-group">
            <input type="text" id="orcCat" placeholder="Categoria (ex: Mercado)">
            <input type="number" id="orcLimite" placeholder="Limite Mensal (R$)">
            <button class="add-btn" onclick="addOrcamento()">+ Criar Or칞amento</button>
        </div>
        <div id="listaOrcamentos">Carregando...</div>
    </div>

    <script>
        // --- 1. CONFIGURA칂츾O SUPABASE ---
        const SUPABASE_URL = 'https://ccktnhugjrgeafmialib.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. L칍GICA DE ABAS ---
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Recarregar dados ao trocar de aba
            if(tabName === 'receitas') loadReceitas();
            if(tabName === 'fixos') loadFixos();
            if(tabName === 'orcamentos') loadOrcamentos();
        }

        // --- 3. FUN칂칏ES RECEITAS ---
        async function loadReceitas() {
            const { data, error } = await supabase.from('receitas').select('*').order('created_at', { ascending: false });
            const lista = document.getElementById('listaReceitas');
            lista.innerHTML = '';
            if (data) {
                data.forEach(r => {
                    lista.innerHTML += `<li><strong>${r.tipo}</strong>: ${r.descricao} <span>R$ ${parseFloat(r.valor).toFixed(2)}</span></li>`;
                });
            }
        }

        async function addReceita() {
            const tipo = document.getElementById('recTipo').value;
            const desc = document.getElementById('recDesc').value;
            const valor = document.getElementById('recValor').value;

            if (!desc || !valor) return alert("Preencha tudo!");

            await supabase.from('receitas').insert([{ tipo, descricao: desc, valor }]);
            document.getElementById('recDesc').value = '';
            document.getElementById('recValor').value = '';
            loadReceitas();
        }

        // --- 4. FUN칂칏ES GASTOS FIXOS ---
        async function loadFixos() {
            const { data } = await supabase.from('gastos_fixos').select('*');
            const lista = document.getElementById('listaFixos');
            lista.innerHTML = '';
            
            if (data) {
                const hoje = new Date();
                data.forEach(f => {
                    // L칩gica: Se data_fim existe E j치 passou, n칚o mostra (ou mostra riscado)
                    let ativo = true;
                    if (f.data_fim) {
                        const fim = new Date(f.data_fim);
                        if (fim < hoje) ativo = false;
                    }

                    if (ativo) {
                        lista.innerHTML += `
                            <li>
                                <div>
                                    <strong>${f.descricao}</strong> <br>
                                    <small>In칤cio: ${f.data_inicio} ${f.data_fim ? '| Fim: '+f.data_fim : ''}</small>
                                </div>
                                <span style="color: #d9534f; font-weight: bold;">R$ ${parseFloat(f.valor).toFixed(2)}</span>
                            </li>`;
                    }
                });
            }
        }

        async function addFixo() {
            const descricao = document.getElementById('fixDesc').value;
            const valor = document.getElementById('fixValor').value;
            const inicio = document.getElementById('fixInicio').value;
            const fim = document.getElementById('fixFim').value || null;

            if (!descricao || !valor || !inicio) return alert("Preencha descri칞칚o, valor e in칤cio!");

            await supabase.from('gastos_fixos').insert([{ descricao, valor, data_inicio: inicio, data_fim: fim }]);
            // Limpar campos
            document.getElementById('fixDesc').value = '';
            document.getElementById('fixValor').value = '';
            loadFixos();
        }

        // --- 5. FUN칂칏ES OR칂AMENTOS ---
        async function loadOrcamentos() {
            const { data } = await supabase.from('orcamentos').select('*');
            const container = document.getElementById('listaOrcamentos');
            container.innerHTML = '';

            if (data) {
                data.forEach(o => {
                    const gasto = parseFloat(o.valor_gasto || 0);
                    const limite = parseFloat(o.valor_limite);
                    const saldo = limite - gasto;
                    const corSaldo = saldo < 0 ? 'red' : 'green';

                    container.innerHTML += `
                        <div class="orcamento-card">
                            <div style="display:flex; justify-content:space-between;">
                                <h3>${o.categoria}</h3>
                                <button onclick="lancarGasto(${o.id}, ${gasto})" style="height:30px;">+ Lan칞ar Gasto</button>
                            </div>
                            <p>Meta: R$ ${limite.toFixed(2)} | Gasto: R$ ${gasto.toFixed(2)}</p>
                            <p style="color:${corSaldo}"><strong>Saldo Restante: R$ ${saldo.toFixed(2)}</strong></p>
                            <progress value="${gasto}" max="${limite}" style="width:100%"></progress>
                        </div>
                    `;
                });
            }
        }

        async function addOrcamento() {
            const cat = document.getElementById('orcCat').value;
            const limite = document.getElementById('orcLimite').value;
            
            if(!cat || !limite) return alert("Preencha tudo!");
            
            await supabase.from('orcamentos').insert([{ categoria: cat, valor_limite: limite }]);
            document.getElementById('orcCat').value = '';
            document.getElementById('orcLimite').value = '';
            loadOrcamentos();
        }

        async function lancarGasto(id, valorAtual) {
            const novoGasto = prompt("Quanto voc칡 gastou agora?");
            if (novoGasto) {
                const total = parseFloat(valorAtual) + parseFloat(novoGasto);
                await supabase.from('orcamentos').update({ valor_gasto: total }).eq('id', id);
                loadOrcamentos();
            }
        }

        // Inicializar na primeira aba
        loadReceitas();

    </script>
</body>
</html>
