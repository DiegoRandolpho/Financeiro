<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro React</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO ---
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        // SUAS CHAVES JÁ CONFIGURADAS
        const SUPABASE_URL = 'https://ccktnhugjrgeafmialib.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja3RuaHVnanJnZWFmbWlhbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYzNzUsImV4cCI6MjA4MzI4MjM3NX0.WB5OQFkFrufYcfzwJpJ7Jf2iZxcwPTpplfzDSeU_OQg';

        // Inicialização do cliente
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- COMPONENTE DE LOGIN (ATUALIZADO PARA SENHA) ---
        function Auth() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [isSignUp, setIsSignUp] = useState(false); // Alternar entre Login e Cadastro

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                let result;
                if (isSignUp) {
                    // Tenta cadastrar
                    result = await sb.auth.signUp({ email, password });
                    if (!result.error && !result.data.session) {
                        alert('Cadastro realizado! Se o login não for automático, verifique seu e-mail para confirmar a conta.');
                    }
                } else {
                    // Tenta logar
                    result = await sb.auth.signInWithPassword({ email, password });
                }

                const { error } = result;
                if (error) {
                    alert('Erro: ' + error.message);
                }
                
                setLoading(false);
            };

            return (
                <div className="flex h-screen items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded shadow-lg w-96">
                        <h2 className="text-2xl font-bold mb-6 text-center text-gray-800">
                            {isSignUp ? 'Criar Nova Conta' : 'Acessar Conta'}
                        </h2>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                                <input 
                                    type="email" 
                                    placeholder="seu@email.com"
                                    className="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                    value={email} 
                                    onChange={e => setEmail(e.target.value)} 
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                <input 
                                    type="password" 
                                    placeholder="******"
                                    className="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                    value={password} 
                                    onChange={e => setPassword(e.target.value)} 
                                    required
                                />
                            </div>

                            <button 
                                disabled={loading} 
                                className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50 transition font-medium shadow-sm"
                            >
                                {loading ? 'Processando...' : (isSignUp ? 'Cadastrar' : 'Entrar')}
                            </button>
                        </form>

                        <div className="mt-6 text-center border-t pt-4">
                            <p className="text-sm text-gray-600 mb-2">
                                {isSignUp ? 'Já tem uma conta?' : 'Ainda não tem conta?'}
                            </p>
                            <button 
                                onClick={() => setIsSignUp(!isSignUp)}
                                className="text-blue-600 font-semibold hover:underline text-sm"
                            >
                                {isSignUp ? 'Fazer Login' : 'Criar Cadastro'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [session, setSession] = useState(null);
            const [activeTab, setActiveTab] = useState('entradas');
            
            // Dados
            const [incomes, setIncomes] = useState([]);
            const [fixedExpenses, setFixedExpenses] = useState([]);
            const [budgets, setBudgets] = useState([]);
            const [variableExpenses, setVariableExpenses] = useState([]);
            
            // Formulários
            const [formIncome, setFormIncome] = useState({ description: '', amount: '', date: '' });
            const [formFixed, setFormFixed] = useState({ description: '', amount: '', start_date: '', end_date: '' });
            const [formBudget, setFormBudget] = useState({ name: '', total_limit: '' });
            const [formVariable, setFormVariable] = useState({ description: '', amount: '', budget_id: '', date: '' });

            useEffect(() => {
                if (!sb) return;

                sb.auth.getSession().then(({ data: { session } }) => setSession(session));
                const { data: { subscription } } = sb.auth.onAuthStateChange((_event, session) => setSession(session));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (session && sb) fetchData();
            }, [session]);

            const fetchData = async () => {
                if (!sb) return;
                const { data: inc } = await sb.from('incomes').select('*').order('date', { ascending: false });
                const { data: fix } = await sb.from('fixed_expenses').select('*');
                const { data: bud } = await sb.from('budgets').select('*');
                const { data: vary } = await sb.from('variable_expenses').select('*');
                
                if (inc) setIncomes(inc);
                if (fix) setFixedExpenses(fix);
                if (bud) setBudgets(bud);
                if (vary) setVariableExpenses(vary);
            };

            // --- AÇÕES ---
            const handleLogout = () => {
                if (sb) sb.auth.signOut();
            };

            const saveIncome = async () => {
                if (!sb || !formIncome.description || !formIncome.amount) return;
                await sb.from('incomes').insert([{ ...formIncome, user_id: session.user.id }]);
                setFormIncome({ description: '', amount: '', date: '' });
                fetchData();
            };

            const saveFixed = async () => {
                if (!sb || !formFixed.description || !formFixed.amount) return;
                const payload = { 
                    ...formFixed, 
                    user_id: session.user.id, 
                    end_date: formFixed.end_date === '' ? null : formFixed.end_date 
                };
                await sb.from('fixed_expenses').insert([payload]);
                setFormFixed({ description: '', amount: '', start_date: '', end_date: '' });
                fetchData();
            };

            const saveBudget = async () => {
                if (!sb || !formBudget.name || !formBudget.total_limit) return;
                await sb.from('budgets').insert([{ ...formBudget, user_id: session.user.id }]);
                setFormBudget({ name: '', total_limit: '' });
                fetchData();
            };

            const saveVariable = async () => {
                if (!sb || !formVariable.description || !formVariable.amount || !formVariable.budget_id) return;
                await sb.from('variable_expenses').insert([{ ...formVariable, user_id: session.user.id }]);
                setFormVariable({ description: '', amount: '', budget_id: '', date: '' });
                fetchData();
            };

            // Cálculo Orçamentos
            const getBudgetStats = (budgetId, limit) => {
                const spent = variableExpenses
                    .filter(v => v.budget_id === budgetId)
                    .reduce((acc, curr) => acc + Number(curr.amount), 0);
                return { spent, remaining: limit - spent };
            };

            if (!sb) return <div className="text-center p-10">Erro: Supabase não inicializado.</div>;
            if (!session) return <Auth />;

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    <div className="flex justify-between items-center mb-6 bg-white p-4 rounded shadow">
                        <h1 className="text-xl font-bold text-gray-700">Meu Controle</h1>
                        <button onClick={handleLogout} className="text-red-500 hover:text-red-700 text-sm font-semibold">Sair</button>
                    </div>

                    {/* NAVEGAÇÃO */}
                    <div className="flex gap-4 mb-6 border-b pb-2 overflow-x-auto">
                        {['entradas', 'fixos', 'orcamentos'].map(tab => (
                            <button 
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 rounded capitalize font-medium transition whitespace-nowrap ${
                                    activeTab === tab ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                }`}
                            >
                                {tab === 'orcamentos' ? 'Variáveis & Orçamentos' : tab}
                            </button>
                        ))}
                    </div>

                    {/* ABA: ENTRADAS */}
                    {activeTab === 'entradas' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded shadow space-y-4">
                                <h3 className="font-bold text-lg">Nova Entrada</h3>
                                <div className="flex flex-wrap gap-2">
                                    <input placeholder="Descrição (Salário...)" className="border p-2 rounded flex-1 min-w-[150px]" value={formIncome.description} onChange={e => setFormIncome({...formIncome, description: e.target.value})} />
                                    <input type="number" placeholder="Valor" className="border p-2 rounded w-32" value={formIncome.amount} onChange={e => setFormIncome({...formIncome, amount: e.target.value})} />
                                    <input type="date" className="border p-2 rounded" value={formIncome.date} onChange={e => setFormIncome({...formIncome, date: e.target.value})} />
                                    <button onClick={saveIncome} className="bg-green-600 text-white px-4 rounded font-bold hover:bg-green-700">+</button>
                                </div>
                            </div>
                            <div className="bg-white rounded shadow overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-50"><tr><th className="p-3">Descrição</th><th className="p-3">Data</th><th className="p-3">Valor</th></tr></thead>
                                    <tbody className="divide-y">
                                        {incomes.length === 0 && <tr><td colSpan="3" className="p-3 text-center text-gray-400">Nenhuma entrada cadastrada.</td></tr>}
                                        {incomes.map(inc => (
                                            <tr key={inc.id}>
                                                <td className="p-3">{inc.description}</td>
                                                <td className="p-3 text-sm text-gray-500">{inc.date}</td>
                                                <td className="p-3 font-bold text-green-600">R$ {inc.amount}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* ABA: GASTOS FIXOS */}
                    {activeTab === 'fixos' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded shadow space-y-4">
                                <h3 className="font-bold text-lg">Novo Gasto Fixo</h3>
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <input placeholder="Ex: Internet" className="border p-2 rounded md:col-span-2" value={formFixed.description} onChange={e => setFormFixed({...formFixed, description: e.target.value})} />
                                    <input type="number" placeholder="Valor" className="border p-2 rounded" value={formFixed.amount} onChange={e => setFormFixed({...formFixed, amount: e.target.value})} />
                                    <input type="date" title="Início" className="border p-2 rounded" value={formFixed.start_date} onChange={e => setFormFixed({...formFixed, start_date: e.target.value})} />
                                    <input type="date" title="Fim (Vazio = Ativo)" className="border p-2 rounded" value={formFixed.end_date} onChange={e => setFormFixed({...formFixed, end_date: e.target.value})} />
                                </div>
                                <button onClick={saveFixed} className="bg-blue-600 text-white px-4 py-2 rounded w-full font-bold hover:bg-blue-700">Cadastrar Fixo</button>
                            </div>

                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="bg-white p-4 rounded shadow border-l-4 border-red-500">
                                    <h4 className="font-bold mb-3 text-red-700">ATIVOS (Mensais)</h4>
                                    <ul className="space-y-2">
                                        {fixedExpenses.filter(f => !f.end_date).length === 0 && <li className="text-gray-400 text-sm">Nenhum gasto fixo ativo.</li>}
                                        {fixedExpenses.filter(f => !f.end_date).map(fix => (
                                            <li key={fix.id} className="flex justify-between border-b pb-1 last:border-0">
                                                <span>{fix.description} <small className="text-gray-400 block">Desde: {fix.start_date}</small></span>
                                                <span className="font-bold">R$ {fix.amount}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <div className="bg-white p-4 rounded shadow border-l-4 border-gray-300 opacity-75">
                                    <h4 className="font-bold mb-3 text-gray-600">ENCERRADOS</h4>
                                    <ul className="space-y-2 text-sm">
                                        {fixedExpenses.filter(f => f.end_date).map(fix => (
                                            <li key={fix.id} className="flex justify-between border-b pb-1 last:border-0">
                                                <span>{fix.description}</span>
                                                <span>Fim: {fix.end_date}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ABA: ORÇAMENTOS E VARIÁVEIS */}
                    {activeTab === 'orcamentos' && (
                        <div className="grid md:grid-cols-2 gap-6">
                            
                            {/* Esquerda: Cadastro */}
                            <div className="space-y-6">
                                <div className="bg-purple-50 p-4 rounded border border-purple-200">
                                    <h3 className="font-bold text-purple-800 mb-2">1. Definir Orçamento (Teto)</h3>
                                    <div className="flex gap-2">
                                        <input placeholder="Categoria (Ex: Mercado)" className="border p-2 rounded flex-1" value={formBudget.name} onChange={e => setFormBudget({...formBudget, name: e.target.value})} />
                                        <input type="number" placeholder="Teto R$" className="border p-2 rounded w-24" value={formBudget.total_limit} onChange={e => setFormBudget({...formBudget, total_limit: e.target.value})} />
                                        <button onClick={saveBudget} className="bg-purple-600 text-white px-3 rounded hover:bg-purple-700">Ok</button>
                                    </div>
                                </div>

                                <div className="bg-orange-50 p-4 rounded border border-orange-200">
                                    <h3 className="font-bold text-orange-800 mb-2">2. Lançar Gasto Variável</h3>
                                    <select className="w-full border p-2 rounded mb-2 bg-white" value={formVariable.budget_id} onChange={e => setFormVariable({...formVariable, budget_id: e.target.value})}>
                                        <option value="">Selecione o Orçamento...</option>
                                        {budgets.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                    </select>
                                    <input placeholder="Descrição da despesa" className="w-full border p-2 rounded mb-2" value={formVariable.description} onChange={e => setFormVariable({...formVariable, description: e.target.value})} />
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="Valor" className="border p-2 rounded flex-1" value={formVariable.amount} onChange={e => setFormVariable({...formVariable, amount: e.target.value})} />
                                        <button onClick={saveVariable} className="bg-orange-600 text-white px-4 rounded hover:bg-orange-700">Lançar</button>
                                    </div>
                                </div>
                            </div>

                            {/* Direita: Visualização */}
                            <div className="space-y-4">
                                <h3 className="font-bold text-gray-700">Acompanhamento</h3>
                                {budgets.length === 0 && <p className="text-gray-400 italic">Nenhum orçamento definido.</p>}
                                {budgets.map(b => {
                                    const { spent, remaining } = getBudgetStats(b.id, b.total_limit);
                                    const percent = Math.min((spent / b.total_limit) * 100, 100);
                                    const isOver = remaining < 0;

                                    return (
                                        <div key={b.id} className="bg-white p-4 rounded shadow border border-gray-100">
                                            <div className="flex justify-between items-end mb-2">
                                                <span className="font-bold text-lg">{b.name}</span>
                                                <div className="text-right text-xs text-gray-500">
                                                    Gasto: R$ {spent} / Teto: R$ {b.total_limit}
                                                </div>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden">
                                                <div 
                                                    className={`h-full transition-all duration-500 ${isOver ? 'bg-red-500' : 'bg-green-500'}`} 
                                                    style={{ width: `${percent}%` }}
                                                ></div>
                                            </div>
                                            <div className={`text-right font-bold ${isOver ? 'text-red-600' : 'text-green-600'}`}>
                                                {isOver ? `Estourou: R$ ${Math.abs(remaining)}` : `Disponível: R$ ${remaining}`}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>

                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
